(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{527:function(t,n,p){"use strict";p.r(n);var e=p(22),s=Object(e.a)({},(function(){var t=this,n=t.$createElement,p=t._self._c||n;return p("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[p("div",{staticClass:"language- line-numbers-mode"},[p("pre",{pre:!0,attrs:{class:"language-text"}},[p("code",[t._v("-t<表>：指定要操纵的表；\n-A：向规则链中添加条目；\n-D：从规则链中删除条目；\n-i：向规则链中插入条目；\n-R：替换规则链中的条目；\n-L：显示规则链中已有的条目；\n-F：清楚规则链中已有的条目；\n-Z：清空规则链中的数据包计算器和字节计数器；\n-N：创建新的用户自定义规则链；\n-P：定义规则链中的默认目标；\n-h：显示帮助信息；\n-p：指定要匹配的数据包协议类型；\n-s：指定要匹配的数据包源ip地址；\n-j<目标>：指定要跳转的目标；\n-i<网络接口>：指定数据包进入本机的网络接口；\n-o<网络接口>：指定数据包要离开本机所使用的网络接口。\n")])]),t._v(" "),p("div",{staticClass:"line-numbers-wrapper"},[p("span",{staticClass:"line-number"},[t._v("1")]),p("br"),p("span",{staticClass:"line-number"},[t._v("2")]),p("br"),p("span",{staticClass:"line-number"},[t._v("3")]),p("br"),p("span",{staticClass:"line-number"},[t._v("4")]),p("br"),p("span",{staticClass:"line-number"},[t._v("5")]),p("br"),p("span",{staticClass:"line-number"},[t._v("6")]),p("br"),p("span",{staticClass:"line-number"},[t._v("7")]),p("br"),p("span",{staticClass:"line-number"},[t._v("8")]),p("br"),p("span",{staticClass:"line-number"},[t._v("9")]),p("br"),p("span",{staticClass:"line-number"},[t._v("10")]),p("br"),p("span",{staticClass:"line-number"},[t._v("11")]),p("br"),p("span",{staticClass:"line-number"},[t._v("12")]),p("br"),p("span",{staticClass:"line-number"},[t._v("13")]),p("br"),p("span",{staticClass:"line-number"},[t._v("14")]),p("br"),p("span",{staticClass:"line-number"},[t._v("15")]),p("br"),p("span",{staticClass:"line-number"},[t._v("16")]),p("br")])]),p("div",{staticClass:"language- line-numbers-mode"},[p("pre",{pre:!0,attrs:{class:"language-text"}},[p("code",[t._v("iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -j SNAT --to 10.0.1.4\n\nnet.ipv4.ip_forward = 1\n\niptables -t nat -A POSTROUTING -o eth0 -s 10.0.1.0/24 -j SNAT --to 40.73.66.12\n\niptables -t nat -A POSTROUTING -s 10.0.1.0/24 -o eth0 -j MASQUERADE\n\n\n\nnmap 192.168.200.210 -p 1-65535\n\nservice iptables save \n")])]),t._v(" "),p("div",{staticClass:"line-numbers-wrapper"},[p("span",{staticClass:"line-number"},[t._v("1")]),p("br"),p("span",{staticClass:"line-number"},[t._v("2")]),p("br"),p("span",{staticClass:"line-number"},[t._v("3")]),p("br"),p("span",{staticClass:"line-number"},[t._v("4")]),p("br"),p("span",{staticClass:"line-number"},[t._v("5")]),p("br"),p("span",{staticClass:"line-number"},[t._v("6")]),p("br"),p("span",{staticClass:"line-number"},[t._v("7")]),p("br"),p("span",{staticClass:"line-number"},[t._v("8")]),p("br"),p("span",{staticClass:"line-number"},[t._v("9")]),p("br"),p("span",{staticClass:"line-number"},[t._v("10")]),p("br"),p("span",{staticClass:"line-number"},[t._v("11")]),p("br"),p("span",{staticClass:"line-number"},[t._v("12")]),p("br"),p("span",{staticClass:"line-number"},[t._v("13")]),p("br")])]),p("p",[t._v("生产环境防火墙")]),t._v(" "),p("p",[t._v("iptables -F\niptables -Z\niptables -X")]),t._v(" "),p("p",[t._v("iptables -A INPUT -p tcp --dport 22 -j ACCEPT\niptables -A OUTPUT -o lo -j ACCEPT")]),t._v(" "),p("p",[t._v("iptables -P OUTPUT ACCEPT\niptables --policy FORWARD DROP\niptables --policy INPUT DROP")]),t._v(" "),p("p",[t._v("自己人，内网网段放行\niptables -A INPUT -s 192.168.200.0/24 -p all -j ACCEPT\niptables -A INPUT -s 192.168.240.0/24 -p all -j ACCEPT")]),t._v(" "),p("p",[t._v("允许PING\niptables -A INPUT -s 192.168.200.250 -i ens33 -p icmp -m icmp --icmp-type 8 -j ACCEPT")]),t._v(" "),p("p",[t._v("iptables用法说明\n1、-t table 指定表\nraw,mangle,nat,filter默认\n2、subcommand子命令\n-N -E -X -P")]),t._v(" "),p("p",[t._v("查看类\n-L: list, 列出指定鏈上的所有规则，本选项须置后\n-n：numberic，以数字格式显示地址和端口号\n-v：verbose，详细信息\n-vv  更详细\n-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值\n--line-numbers：显示规则的序号\n-S  selected,以iptables-save 命令格式显示链上规则\n常用组合\n-vnL\n-vvnxL --line-numbers")]),t._v(" "),p("p",[t._v("规则管理类\n-A：append，追加\n-I：insert, 插入，要指明插入至的规则编号，默认为第一条\n-D：delete，删除\n(1) 指明规则序号\n(2) 指明规则本身\n-R：replace，替换指定链上的指定规则编号\n-F：flush，清空指定的规则链\n-Z：zero，置零\niptables的每条规则都有两个计数器\n(1) 匹配到的报文的个数\n(2) 匹配到的所有报文的大小之和")]),t._v(" "),p("p",[t._v("3、chain\nPREROUTING,INPUT,FORWARD,OUTPUT,POSTROUTING")]),t._v(" "),p("p",[t._v("4、处理动作\n-j targetname options\n简单 ACCEPT，DROP\n扩展：\nREJECT： -reject-with:icmp-port-unreachable 默认\nRETURN：返回调用链\nREDIRECT：端口重写向\nLOG：记录日志，dmesg\nMARK：做防火墙标记\nDNAT：目标地址转换\nSNAT：源地址转换\nMASQUERADE：地址伪装\n自定义链")]),t._v(" "),p("p",[t._v("5、iptables基本匹配条件")]),t._v(" "),p("div",{staticClass:"language- extra-class"},[p("pre",[p("code",[t._v("] -s, --source  address[/mask][,...]：源IP地址或者不连续的IP地址\n")])])]),p("p",[t._v("[!] -d, --destination address[/mask][,...]：目标IP地址或者不连续的IP地址\n[!] -p, --protocol protocol：指定协议，可使用数字如0（all）\nprotocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or“all“"),p("br"),t._v("\n参看：/etc/protocols\n[!] -i, --in-interface name：报文流入的接口；只能应用于数据报文流入环节，只应用于INPUT、FORWARD、PREROUTING链\n[!] -o, --out-interface name：报文流出的接口；只能应用于数据报文流出的环节，只应用于FORWARD、OUTPUT、POSTROUTING链")]),t._v(" "),p("p",[t._v("范例：\niptables -A INPUT -s 10.0.0.6,10.0.0.10 -j REJECT\niptables -I INPUT -i lo -j ACCEPT")]),t._v(" "),p("p",[t._v("扩展匹配条件\nman iptables-extensions")]),t._v(" "),p("p",[t._v("隐式扩展\n显式扩展\n隐式扩展\niptables 在使用-p选项指明了特定的协议时，无需再用-m选项指明扩展模块的扩展机制，不需要手动加载扩展模块")]),t._v(" "),p("p",[t._v("tcp协议的扩展选项\n[!] –source-port, –sport port[:port]：匹配报文源端口,可为端口连续范围\n[!] –destination-port,–dport port[:port]：匹配报文目标端口,可为连续范围\n[!] –tcp-flags mask comp\nmask 需检查的标志位列表，用,分隔\n例如 SYN,ACK,FIN,RST\ncomp 在mask列表中必须为1的标志位列表，无指定则必须为0，用,分隔tcp协议的扩展选项\n范例：\ntcp-flags  SYN,ACK,FIN,RST  SYN  表示要检查的标志位为SYN,ACK,FIN,RST四个，其中SYN必须为1，余下的必须为0，第一次握手\n--tcp-flags  SYN,ACK,FIN,RST  SYN,ACK  第二次握手")]),t._v(" "),p("p",[t._v("--tcp-flags ALL ALL"),p("br"),t._v("\n--tcp_flags ALL NONE")]),t._v(" "),p("p",[t._v("[!] –syn：用于匹配第一次握手, 相当于：–tcp-flags SYN,ACK,FIN,RST SYN")]),t._v(" "),p("p",[t._v("udp 协议的扩展选项")]),t._v(" "),p("p",[t._v("[!] --source-port, --sport port[:port]：匹配报文的源端口或端口范围\n[!] --destination-port,--dport port[:port]：匹配报文的目标端口或端口范围\nicmp 协议的扩展选项")]),t._v(" "),p("p",[t._v("[!] --icmp-type {type[/code]|typename}\ntype/code\n0/0   echo-reply        icmp应答\n8/0   echo-request      icmp请求")]),t._v(" "),p("p",[t._v("范例：\niptables -A INPUT -s 10.0.0.6 -p tcp --dport 21:23 -j REJECT")]),t._v(" "),p("div",{staticClass:"language- extra-class"},[p("pre",[p("code",[t._v("iptables -A INPUT  -p tcp --syn  -j REJECT\n\niptables -A INPUT -s 10.0.0.6 -p icmp --icmp-type 8 -j \n")])])]),p("p",[t._v("显式扩展及相关模块\n显示扩展即必须使用-m选项指明要调用的扩展模块名称，需要手动加载扩展模块")]),t._v(" "),p("p",[t._v("[-m matchname [per-match-options]]")]),t._v(" "),p("p",[t._v("扩展模块的使用帮助：")]),t._v(" "),p("p",[t._v("CentOS 6: man iptables\nCentOS 7,8: man iptables-extensions\nmultiport扩展\n​ 以离散方式定义多端口匹配,最多指定15个端口")]),t._v(" "),p("p",[t._v("#多个源或目标端\n[!] --ports port[,port|,port:port]...")]),t._v(" "),p("p",[t._v("#指定多个源端口\n[!] --source-ports,--sports port[,port|,port:port]...")]),t._v(" "),p("h1",{attrs:{id:"指定多个目标端口"}},[p("a",{staticClass:"header-anchor",attrs:{href:"#指定多个目标端口"}},[t._v("#")]),t._v(" 指定多个目标端口")]),t._v(" "),p("p",[t._v("[!] --destination-ports,--dports port[,port|,port:port]...")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("[root@centos8 ~]#iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp -m multiport --dports 20:22,80 -j ACCEPT")]),t._v(" "),p("p",[t._v("[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p tcp -m multiport --dports 445,139 -j REJECT\n[root@centos8 ~]#ipn\nChain INPUT (policy ACCEPT 0 packets, 0 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination"),p("br"),t._v("\n1        2   120 REJECT     tcp  --  *      *       10.0.0.6             0.0.0.0/0            multiport dports 445,139 reject-with icmp-port-unreachable")]),t._v(" "),p("p",[t._v("Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination"),p("br"),t._v("\ndestination")]),t._v(" "),p("p",[t._v("iprange扩展\n指明连续的（但一般不是整个网络）ip地址范围")]),t._v(" "),p("p",[t._v("[!] --src-range from[-to]   源IP地址范围\n[!] --dst-range from[-to]   目标IP地址范围")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("iptables -A INPUT -d 172.16.1.100 -p tcp --dport 80 -m iprange --src-range 172.16.1.5-172.16.1.10 -j DROP")]),t._v(" "),p("p",[t._v("mac扩展\nmac 模块可以指明源MAC地址,，适用于：PREROUTING, FORWARD，INPUT chains")]),t._v(" "),p("p",[t._v("[!] --mac-source XX:XX:XX:XX:XX:XX")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("iptables -A INPUT -s 172.16.0.100 -m mac  --mac-source  00:50:56:12:34:56 -j ACCEPT\niptables -A INPUT -s 172.16.0.100  -j REJECT")]),t._v(" "),p("p",[t._v("3.4.2.4 string扩展\n对报文中的应用层数据做字符串模式匹配检测")]),t._v(" "),p("p",[t._v("--algo {bm|kmp} 字符串匹配检测算法\nbm：Boyer-Moore\nkmp：Knuth-Pratt-Morris\n--from offset       开始偏移\n--to offset         结束偏移\n[!] --string pattern    要检测的字符串模式\n[!] --hex-string pattern要检测字符串模式，16进制格式")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v('iptables -A OUTPUT -p tcp --sport 80 -m string --algo bm --from 62  --string   "google" -j REJECT')]),t._v(" "),p("p",[t._v("注意：CentOS 8 此模块有问题")]),t._v(" "),p("p",[t._v("根据将报文到达的时间与指定的时间范围进行匹配")]),t._v(" "),p("p",[t._v("--datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]]  日期\n--datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]\n--timestart hh:mm[:ss]        时间\n--timestop hh:mm[:ss]\n[!] --monthdays day[,day...]   每个月的几号\n[!] --weekdays day[,day...]   星期几，1 – 7 分别表示星期一到星期日\n--kerneltz：内核时区（当地时间），不建议使用，CentOS 7 系统默认为 UTC\n注意： centos6 不支持kerneltz ，--localtz指定本地时区(默认)")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("[root@centos7 ~]#iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp --dport 80 -m time --timestart 14:30 --timestop 18:30 --weekdays Sat,Sun --kerneltz -j DROP")]),t._v(" "),p("p",[t._v("connlimit扩展\n根据每客户端IP做并发连接数数量匹配\n可防止Dos(Denial of Service，拒绝服务)攻击")]),t._v(" "),p("p",[t._v("--connlimit-upto        #连接的数量小于等于#时匹配\n--connlimit-above       #连接的数量大于#时匹配\n范例：")]),t._v(" "),p("p",[t._v("iptables -A INPUT -d 172.16.100.10 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT\nlimit扩展\n基于收发报文的速率做匹配\n令牌桶过滤器")]),t._v(" "),p("p",[t._v("--limit #[/second|/minute|/hour|/day]\n--limit-burst number    #前多少个包不限制\n范例：")]),t._v(" "),p("p",[t._v("iptables -I INPUT -d 172.16.100.10 -p icmp --icmp-type 8 -m limit --limit 10/minute --limit-burst 5 -j ACCEPT\niptables -I INPUT 2 -p icmp -j REJECT\n范例：")]),t._v(" "),p("p",[t._v("[root@centos8 ~]#iptables -A INPUT -p icmp -m limit --limit-burst 10 --limit 20/minute -j ACCEPT\n[root@centos8 ~]#iptables -A INPUT -p icmp  -j REJECT")]),t._v(" "),p("p",[t._v("[root@centos6 ~]#ping 10.0.0.8")]),t._v(" "),p("p",[t._v("state扩展\nstate扩展模块，可以根据”连接追踪机制“去检查连接的状态，较耗资源\nconntrack机制：追踪本机上的请求和响应之间的关系")]),t._v(" "),p("p",[t._v("状态类型：")]),t._v(" "),p("p",[t._v("-NEW：新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求")]),t._v(" "),p("p",[t._v("-ESTABLISHED：NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态\n-RELATED：新发起的但与已有连接相关联的连接，如：ftp协议中的数据连接与命令连接之间的关系\n-INVALID：无效的连接，如flag标记不正确\n-UNTRACKED：未进行追踪的连接，如：raw表中关闭追踪")]),t._v(" "),p("p",[t._v("已经追踪到的并记录下来的连接信息库")]),t._v(" "),p("p",[t._v("[root@centos8 ~]#cat /proc/net/nf_conntrack")]),t._v(" "),p("p",[t._v("[root@centos8 ~]#cat /proc/sys/net/netfilter/nf_conntrack_max\n26624")]),t._v(" "),p("p",[t._v("查看连接跟踪有多少条目")]),t._v(" "),p("p",[t._v("[root@centos8 ~]#cat /proc/sys/net/netfilter/nf_conntrack_count")]),t._v(" "),p("p",[t._v("不同的协议的连接追踪时长")]),t._v(" "),p("p",[t._v("说明：")]),t._v(" "),p("p",[t._v("-连接跟踪，需要加载模块： modprobe nf_conntrack_ipv4")]),t._v(" "),p("p",[t._v("-当服务器连接多于最大连接数时dmesg 可以观察到 ：kernel: ip_conntrack: table full, dropping packet错误,并且导致建立TCP连接很慢。")]),t._v(" "),p("p",[t._v("-各种状态的超时后，链接会从表中删除")]),t._v(" "),p("p",[t._v("连接过多的解决方法两个：")]),t._v(" "),p("p",[t._v("(1) 加大nf_conntrack_max 值")]),t._v(" "),p("p",[t._v("vi /etc/sysctl.conf\nnet.nf_conntrack_max = 393216\nnet.netfilter.nf_conntrack_max = 393216")]),t._v(" "),p("p",[t._v("(2) 降低 nf_conntrack timeout时间")]),t._v(" "),p("p",[t._v("vi /etc/sysctl.conf\nnet.netfilter.nf_conntrack_tcp_timeout_established = 300\nnet.netfilter.nf_conntrack_tcp_timeout_time_wait = 120\nnet.netfilter.nf_conntrack_tcp_timeout_close_wait = 60\nnet.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120\niptables -t nat -L -n\n格式：")]),t._v(" "),p("p",[t._v("[!] --state state\nstate\n范例：")]),t._v(" "),p("p",[t._v("iptables -A INPUT -d 172.16.1.10 -p tcp -m multiport --dports 22,80 -m state --state NEW,ESTABLISHED -j ACCEPT\niptables -A OUTPUT -s 172.16.1.10 -p tcp -m multiport --sports 22,80 -m state --state ESTABLISHED -j ACCEPT")]),t._v(" "),p("p",[t._v("[root@centos8 ~]#iptables -A INPUT  -m state --state ESTABLISHED -j ACCEPT\n[root@centos8 ~]#iptables -A INPUT  -m state --state NEW -j REJECT\n案例：开放被动模式的ftp服务")]),t._v(" "),p("p",[t._v("CentOS 8 此模块有bug")]),t._v(" "),p("p",[t._v("(1) 装载ftp连接追踪的专用模块：\n跟踪模块路径：\n/lib/modules/kernelversion/kernel/net/netfilter")]),t._v(" "),p("p",[t._v('vim /etc/sysconfig/iptables-config\nIPTABLES_MODULES=“nf_conntrack_ftp"\nmodprobe  nf_conntrack_ftp\n(2) 放行请求报文：\n命令连接：NEW, ESTABLISHED\n数据连接：RELATED, ESTABLISHED')]),t._v(" "),p("p",[t._v("iptables -I INPUT -d LocalIP -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT"),p("br"),t._v("\niptables -A INPUT -d LocalIP -p tcp --dport 21 -m state --state NEW -j ACCEPT\n(3) 放行响应报文：")]),t._v(" "),p("p",[t._v("iptables -I OUTPUT -s LocalIP -p tcp -m state --state ESTABLISHED -j ACCEPT\n范例：开放被动模式的ftp服务示例")]),t._v(" "),p("p",[t._v("iptables -F\niptables -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT\niptables -A INPUT -p tcp --dport 21 -m state --state NEW -j ACCEPT\niptables -A OUTPUT  -m state --state ESTABLISHED -j ACCEPT\niptables -P INPUT DROP\niptables -P OUTPUT DROP\niptables -vnL")]),t._v(" "),p("p",[t._v("Target\ntarge包括以下类型：")]),t._v(" "),p("p",[t._v("ACCEPT， DROP， REJECT， RETURN,LOG，SNAT，DNAT，REDIRECT，MASQUERADE")]),t._v(" "),p("p",[t._v("LOG：非中断target,本身不拒绝和允许,放在拒绝和允许规则前，并将日志记录在/var/log/messages系统日志中\n--log-level level    级别： debug，info，notice, warning, error, crit, alert,emerg\n--log-prefix prefix 日志前缀，用于区别不同的日志，最多29个字符\n范例：")]),t._v(" "),p("p",[t._v('[root@centos8 ~]#iptables -I INPUT  -s 10.0.1.0/24 -p tcp -m multiport --dports 80,21,22,23 -m state --state NEW -j LOG --log-prefix "new connections: "')]),t._v(" "),p("p",[t._v("[root@centos8 ~]#tail -f /var/log/messages")]),t._v(" "),p("p",[t._v('[root@centos8 ~]#iptables -R INPUT 2 -p tcp --dport 21 -m state --state NEW -j LOG --log-prefix "ftp new link: "')]),t._v(" "),p("p",[t._v("[root@centos8 ~]#tail -f /var/log/messages")]),t._v(" "),p("p",[t._v("规则优化最佳实践\n1.安全放行所有入站和出站的状态为ESTABLISHED状态连接,建议放在第一条，效率更高")]),t._v(" "),p("p",[t._v("2.谨慎放行入站的新请求")]),t._v(" "),p("p",[t._v("3.有特殊目的限制访问功能，要在放行规则之前加以拒绝")]),t._v(" "),p("p",[t._v("4.同类规则（访问同一应用，比如：http ），匹配范围小的放在前面，用于特殊处理")]),t._v(" "),p("p",[t._v("5.不同类的规则（访问不同应用，一个是http，另一个是mysql ），匹配范围大的放在前面，效率更高")]),t._v(" "),p("p",[t._v("-s 10.0.0.6 -p tcp --dport 3306  -j REJECT\n-s 172.16.0.0/16 -p tcp --dport 80  -j REJECT\n6.应该将那些可由一条规则能够描述的多个规则合并为一条")]),t._v(" "),p("p",[t._v("7.设置默认策略，建议白名单（只放行特定连接）")]),t._v(" "),p("p",[t._v("-iptables -P，不建议，容易出现“自杀现象”")]),t._v(" "),p("p",[t._v("-规则的最后定义规则做为默认策略，推荐使用，放在最后一条")]),t._v(" "),p("p",[t._v("iptables规则保存")]),t._v(" "),p("p",[t._v("使用iptables命令定义的规则，手动删除之前，其生效期限为kernel存活期限")]),t._v(" "),p("p",[t._v("持久保存规则：")]),t._v(" "),p("p",[t._v("CentOS 7,8")]),t._v(" "),p("p",[t._v("iptables-save  >  /PATH/TO/SOME_RULES_FILE")]),t._v(" "),p("p",[t._v("CentOS 6：")]),t._v(" "),p("p",[t._v("#会自动从/etc/sysconfig/iptables 重新载入规则\nservice  iptables  restart")]),t._v(" "),p("p",[t._v("-用脚本保存各iptables命令；让此脚本开机后自动运行\n/etc/rc.d/rc.local文件中添加脚本路径 /PATH/TO/SOME_SCRIPT_FILE")]),t._v(" "),p("p",[t._v("-用规则文件保存各规则，开机时自动载入此规则文件中的规则\n在/etc/rc.d/rc.local文件添加")]),t._v(" "),p("p",[t._v("iptables-restore < /PATH/FROM/IPTABLES_RULES_FILE")]),t._v(" "),p("p",[t._v("定义Unit File, CentOS 7，8 可以安装 iptables-services 实现iptables.service")]),t._v(" "),p("p",[t._v("yum install iptables-services\ncp /etc/sysconfig/iptables{,.bak}\niptables-save > /etc/sysconfig/iptables\nsystemctl enable iptables.service")]),t._v(" "),p("p",[t._v("网络防火墙\niptables/netfilter 利用filter表的FORWARD链,可以充当网络防火墙：\n注意的问题：\n(1) 请求-响应报文均会经由FORWARD链，要注意规则的方向性\n(2) 如果要启用conntrack机制，建议将双方向的状态为ESTABLISHED的报文直接放行")]),t._v(" "),p("p",[t._v("FORWARD 链实现内外网络的流量控制\n范例：内部可以访问外部，外部禁止访问内部")]),t._v(" "),p("p",[t._v("iptables -A FORWARD -d 192.168.100.0/24  -m state --state NEW  -j REJECT")]),t._v(" "),p("p",[t._v("范例：针对内部的特定服务可以允许外部访问，其它服务禁止访问\niptables -I FORWARD -d 192.168.100.0/24 -p tcp --dport 80 -j ACCEPT\niptables -vnL  FORWARD --line-numbers")]),t._v(" "),p("p",[t._v("NAT 表")]),t._v(" "),p("p",[t._v("NAT: network address translation，支持PREROUTING，INPUT，OUTPUT，POSTROUTING四个链")]),t._v(" "),p("p",[t._v("请求报文：修改源/目标IP，由定义如何修改")]),t._v(" "),p("p",[t._v("响应报文：修改源/目标IP，根据跟踪机制自动实现")]),t._v(" "),p("p",[t._v("NAT的实现分为下面类型：")]),t._v(" "),p("p",[t._v("SNAT：source NAT ，支持POSTROUTING, INPUT，让本地网络中的主机通过某一特定地址访问外部网络，实现地址伪装,请求报文：修改源IP\nDNAT：destination NAT 支持PREROUTING , OUTPUT，把本地网络中的主机上的某服务开放给外部网络访问(发布服务和端口映射)，但隐藏真实IP,请求报文：修改目标IP\nPNAT: port nat，端口和IP都进行修改\n范例：查看本地主机访问公网时使用的IP")]),t._v(" "),p("p",[t._v("SNAT\nSNAT：基于nat表的target，适用于固定的公网IP")]),t._v(" "),p("p",[t._v("SNAT选项：")]),t._v(" "),p("p",[t._v("–to-source [ipaddr[-ipaddr]][:port[-port]]\n–random\niptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j SNAT --to-source ExtIP")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! –d 10.0.1.0/24 -j SNAT --to-source 172.18.1.6-172.18.1.9")]),t._v(" "),p("p",[t._v("MASQUERADE：基于nat表的target，适用于动态的公网IP，如：拨号网络")]),t._v(" "),p("p",[t._v("MASQUERADE选项：")]),t._v(" "),p("p",[t._v("–to-ports port[-port]\n–random\niptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j MASQUERADE")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("iptables -t nat -A POSTROUTING -s 10.0.1.0/24  ! –d 10.0.1.0/24 -j MASQUERADE")]),t._v(" "),p("p",[t._v("范例：实现SNAT")]),t._v(" "),p("p",[t._v("net.ipv4.ip_forward = 1\niptables -t nat -A POSTROUTING -s 192.168.100.0/24 -j SNAT --to-source 10.0.0.8")]),t._v(" "),p("p",[t._v("iptables -t nat -R POSTROUTING 1  -s 192.168.100.0/24 -j MASQUERADE")]),t._v(" "),p("p",[t._v("DNAT\nDNAT：nat表的target，适用于端口映射，即可重定向到本机，也可以支持重定向至不同主机的不同端口，但不支持多目标，即不支持负载均衡功能")]),t._v(" "),p("p",[t._v("DNAT选项：")]),t._v(" "),p("p",[t._v("–to-destination [ipaddr[-ipaddr]][:port[-port]]")]),t._v(" "),p("p",[t._v("iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --to-destination InterSeverIP[:PORT]")]),t._v(" "),p("p",[t._v("iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 22 -j DNAT --to-destination 10.0.1.22")]),t._v(" "),p("p",[t._v("iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 80 -j DNAT --to-destination 10.0.1.22:8080")]),t._v(" "),p("p",[t._v("REDIRECT 转发\nREDIRECT，是NAT表的 target，通过改变目标IP和端口，将接受的包转发至同一个主机的不同端口，可用于PREROUTING OUTPUT链\nREDIRECT选项：")]),t._v(" "),p("p",[t._v("—to-ports port[-port]")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("iptables -t nat -A PREROUTING -d 172.16.100.10 -p tcp --dport 80 -j REDIRECT --to-ports 8080")]),t._v(" "),p("p",[t._v("范例：")]),t._v(" "),p("p",[t._v("iptables -t nat -A PREROUTING  -p tcp --dport 8000 -j REDIRECT --to-ports 80")]),t._v(" "),p("p",[t._v("迁移iptables规则到nft")]),t._v(" "),p("p",[t._v("iptables-save > rules.iptables")]),t._v(" "),p("p",[t._v("iptables-restore-translate -f rules.iptables > rules.nft")]),t._v(" "),p("p",[t._v("nft -f rules.nft     ### load the rule via nft to nftables.")]),t._v(" "),p("p",[t._v("nft list ruleset")]),t._v(" "),p("p",[t._v("6.只允许10.220.5.188发送httpd请求\n[root@ken ~]# iptables -A INPUT -s 10.220.5.188 -p tcp --dport 80 --tcp-flags syn,ack,fin syn -j ACCEPT")]),t._v(" "),p("p",[t._v("7.限制只有10.220.5.188可以连接ssh\n[root@ken ~]# iptables -A INPUT -s 10.220.5.188 -p tcp --dport 22 -j ACCEPT")]),t._v(" "),p("p",[t._v("8.允许10.220.5.188访问本机22，80，3306，100到200的端口\n[root@ken ~]# iptables -A INPUT -p tcp -m multiport --dport 22,80,3306,100:200 -m state --state NEW,ESTABLISHED -j ACCEPT")]),t._v(" "),p("p",[t._v("9.只允许ip地址10.220.5.10至10.220.5.20之间的主机访问本机的web网站\n[root@ken ~]# iptables -A INPUT -p tcp --dport 80 -m iprange --src-range 10.220.5.10-10.220.5.20 -j ACCEPT")]),t._v(" "),p("ol",{attrs:{start:"10"}},[p("li",[t._v("防暴力破解&DOS攻击，限制请求登录22端口的频率\n[root@ken ~]# iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m limit --limit 10/minute --limit-burst 20 -j ACCEPT\n[root@ken ~]# iptables -A INPUT -p tcp --dport 22 -m state --state ESTABLISHED -j ACCEPT")])]),t._v(" "),p("p",[t._v('11.限制只能从10.220.5.188登录后台界面（admin.php）\n[root@ken ~]# iptables -A INPUT -s 10.220.5.188 -m string --algo bm --string "admin.php" -j ACCEPT')]),t._v(" "),p("p",[t._v("12.限制每个用户只能同时登录5个ssh\n[root@ken ~]# iptables -A INPUT -p tcp --dport 22 -m connlimit ! --connlimit-above 5 -j ACCEPT")]),t._v(" "),p("p",[t._v("13.限制每个客户端只能与80端口并发连接10个链接\n[root@ken ~]#  iptables -A INPUT -p tcp --dport 80 -m state --state NEW,ESTABLISHED -m connlimit ！--connlimit-above 10 -j ACCEPT")]),t._v(" "),p("p",[t._v("14.指定在1h只登录达到5次之上的，该次链接请求会被丢弃\n[root@ken ~]# iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --name loginSSH --update --seconds 3600 --hitcount 5 -j DROP")]),t._v(" "),p("p",[t._v("15.保存iptables规则\n[root@ken ~]# service iptables save")])])}),[],!1,null,null,null);n.default=s.exports}}]);