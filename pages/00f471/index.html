<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>jenkins | 小诺文档中心</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <meta name="description" content="运维技术文档,mysql,k8s,docker,linux,shell,python等技术文章。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="运维技术文档,mysql,k8s,docker,linux,shell,python,技术文档,学习,面试,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.92233c96.css" as="style"><link rel="preload" href="/assets/js/app.38f1b0a4.js" as="script"><link rel="preload" href="/assets/js/2.6beb1dc7.js" as="script"><link rel="preload" href="/assets/js/30.23c0524a.js" as="script"><link rel="prefetch" href="/assets/js/10.4365b950.js"><link rel="prefetch" href="/assets/js/100.8dac6c81.js"><link rel="prefetch" href="/assets/js/101.a5556ac1.js"><link rel="prefetch" href="/assets/js/102.e3ff38b9.js"><link rel="prefetch" href="/assets/js/103.3bcf44f5.js"><link rel="prefetch" href="/assets/js/104.6d56e53e.js"><link rel="prefetch" href="/assets/js/105.4fc9762e.js"><link rel="prefetch" href="/assets/js/106.f507561a.js"><link rel="prefetch" href="/assets/js/107.6c94c756.js"><link rel="prefetch" href="/assets/js/108.f7ff1945.js"><link rel="prefetch" href="/assets/js/109.aeb1e532.js"><link rel="prefetch" href="/assets/js/11.fe1ff844.js"><link rel="prefetch" href="/assets/js/110.dda67b83.js"><link rel="prefetch" href="/assets/js/111.5b990f24.js"><link rel="prefetch" href="/assets/js/112.0a27d3a0.js"><link rel="prefetch" href="/assets/js/113.972cd001.js"><link rel="prefetch" href="/assets/js/114.875814a1.js"><link rel="prefetch" href="/assets/js/115.ec235d59.js"><link rel="prefetch" href="/assets/js/116.03bd2386.js"><link rel="prefetch" href="/assets/js/117.68765825.js"><link rel="prefetch" href="/assets/js/118.9d6d0255.js"><link rel="prefetch" href="/assets/js/119.ff84a82f.js"><link rel="prefetch" href="/assets/js/12.aa21f453.js"><link rel="prefetch" href="/assets/js/120.20639785.js"><link rel="prefetch" href="/assets/js/121.6c546150.js"><link rel="prefetch" href="/assets/js/122.48e85de5.js"><link rel="prefetch" href="/assets/js/123.fc931745.js"><link rel="prefetch" href="/assets/js/124.797d5fda.js"><link rel="prefetch" href="/assets/js/125.b23a31c7.js"><link rel="prefetch" href="/assets/js/126.d7a182fd.js"><link rel="prefetch" href="/assets/js/127.167a63d6.js"><link rel="prefetch" href="/assets/js/128.878d4a7e.js"><link rel="prefetch" href="/assets/js/129.a8957dfa.js"><link rel="prefetch" href="/assets/js/13.161be064.js"><link rel="prefetch" href="/assets/js/130.3961a295.js"><link rel="prefetch" href="/assets/js/131.9c4e7a56.js"><link rel="prefetch" href="/assets/js/132.41d26584.js"><link rel="prefetch" href="/assets/js/133.6d91047e.js"><link rel="prefetch" href="/assets/js/134.121ecf0e.js"><link rel="prefetch" href="/assets/js/135.6e30234c.js"><link rel="prefetch" href="/assets/js/136.6fab7ce4.js"><link rel="prefetch" href="/assets/js/137.209af36e.js"><link rel="prefetch" href="/assets/js/138.660f236e.js"><link rel="prefetch" href="/assets/js/139.81c29d19.js"><link rel="prefetch" href="/assets/js/14.d0f13635.js"><link rel="prefetch" href="/assets/js/140.d8f594ca.js"><link rel="prefetch" href="/assets/js/141.89fbea1c.js"><link rel="prefetch" href="/assets/js/142.643bccec.js"><link rel="prefetch" href="/assets/js/143.f270bffc.js"><link rel="prefetch" href="/assets/js/144.cf6f4c9a.js"><link rel="prefetch" href="/assets/js/145.093699b5.js"><link rel="prefetch" href="/assets/js/146.876575d0.js"><link rel="prefetch" href="/assets/js/147.dc120635.js"><link rel="prefetch" href="/assets/js/148.4a3ba80f.js"><link rel="prefetch" href="/assets/js/149.4afb7469.js"><link rel="prefetch" href="/assets/js/15.af46dbb5.js"><link rel="prefetch" href="/assets/js/150.4eb38cf2.js"><link rel="prefetch" href="/assets/js/151.4fe6a931.js"><link rel="prefetch" href="/assets/js/16.4cbf8beb.js"><link rel="prefetch" href="/assets/js/17.1da2b6ae.js"><link rel="prefetch" href="/assets/js/18.0402bfbf.js"><link rel="prefetch" href="/assets/js/19.230bfe93.js"><link rel="prefetch" href="/assets/js/20.0d20ddb2.js"><link rel="prefetch" href="/assets/js/21.9dbdbc8b.js"><link rel="prefetch" href="/assets/js/22.1410508d.js"><link rel="prefetch" href="/assets/js/23.63089216.js"><link rel="prefetch" href="/assets/js/24.e6fe9306.js"><link rel="prefetch" href="/assets/js/25.1240d0c9.js"><link rel="prefetch" href="/assets/js/26.0f4fb46d.js"><link rel="prefetch" href="/assets/js/27.5b193a22.js"><link rel="prefetch" href="/assets/js/28.90e27733.js"><link rel="prefetch" href="/assets/js/29.cdb75f6c.js"><link rel="prefetch" href="/assets/js/3.1229de89.js"><link rel="prefetch" href="/assets/js/31.bc292e1e.js"><link rel="prefetch" href="/assets/js/32.79645dcf.js"><link rel="prefetch" href="/assets/js/33.53e29142.js"><link rel="prefetch" href="/assets/js/34.7ce01d2e.js"><link rel="prefetch" href="/assets/js/35.bcdc888c.js"><link rel="prefetch" href="/assets/js/36.00ce19aa.js"><link rel="prefetch" href="/assets/js/37.e53fea30.js"><link rel="prefetch" href="/assets/js/38.1b84e50f.js"><link rel="prefetch" href="/assets/js/39.ed0470cb.js"><link rel="prefetch" href="/assets/js/4.93dbb352.js"><link rel="prefetch" href="/assets/js/40.010f2420.js"><link rel="prefetch" href="/assets/js/41.7aefa9d2.js"><link rel="prefetch" href="/assets/js/42.eadeaa1f.js"><link rel="prefetch" href="/assets/js/43.012419aa.js"><link rel="prefetch" href="/assets/js/44.aa86bffd.js"><link rel="prefetch" href="/assets/js/45.b7ce8c1a.js"><link rel="prefetch" href="/assets/js/46.bd51c47b.js"><link rel="prefetch" href="/assets/js/47.71d2a52e.js"><link rel="prefetch" href="/assets/js/48.71b9430b.js"><link rel="prefetch" href="/assets/js/49.d92deee5.js"><link rel="prefetch" href="/assets/js/5.9228d2a8.js"><link rel="prefetch" href="/assets/js/50.2827e7a9.js"><link rel="prefetch" href="/assets/js/51.94c41d82.js"><link rel="prefetch" href="/assets/js/52.73681932.js"><link rel="prefetch" href="/assets/js/53.4db7ebcf.js"><link rel="prefetch" href="/assets/js/54.8e6699ab.js"><link rel="prefetch" href="/assets/js/55.3d832a8c.js"><link rel="prefetch" href="/assets/js/56.43282683.js"><link rel="prefetch" href="/assets/js/57.ea8d4f37.js"><link rel="prefetch" href="/assets/js/58.12ff8ca5.js"><link rel="prefetch" href="/assets/js/59.47100612.js"><link rel="prefetch" href="/assets/js/6.341b2c5d.js"><link rel="prefetch" href="/assets/js/60.914e7e2d.js"><link rel="prefetch" href="/assets/js/61.d9414480.js"><link rel="prefetch" href="/assets/js/62.a3747f73.js"><link rel="prefetch" href="/assets/js/63.1a2e54c1.js"><link rel="prefetch" href="/assets/js/64.d9f9224a.js"><link rel="prefetch" href="/assets/js/65.53e3f7bd.js"><link rel="prefetch" href="/assets/js/66.92d44566.js"><link rel="prefetch" href="/assets/js/67.67aba1d2.js"><link rel="prefetch" href="/assets/js/68.acce7dfb.js"><link rel="prefetch" href="/assets/js/69.3dacbd45.js"><link rel="prefetch" href="/assets/js/7.3d063b98.js"><link rel="prefetch" href="/assets/js/70.b40c0f61.js"><link rel="prefetch" href="/assets/js/71.51b34635.js"><link rel="prefetch" href="/assets/js/72.498f4ff0.js"><link rel="prefetch" href="/assets/js/73.b22c0978.js"><link rel="prefetch" href="/assets/js/74.823f2a12.js"><link rel="prefetch" href="/assets/js/75.d24d261d.js"><link rel="prefetch" href="/assets/js/76.44db605e.js"><link rel="prefetch" href="/assets/js/77.efce42e9.js"><link rel="prefetch" href="/assets/js/78.11405a06.js"><link rel="prefetch" href="/assets/js/79.9f0076d7.js"><link rel="prefetch" href="/assets/js/8.812a9a47.js"><link rel="prefetch" href="/assets/js/80.4fc1dc52.js"><link rel="prefetch" href="/assets/js/81.f8963444.js"><link rel="prefetch" href="/assets/js/82.627d5503.js"><link rel="prefetch" href="/assets/js/83.49c45765.js"><link rel="prefetch" href="/assets/js/84.b2045805.js"><link rel="prefetch" href="/assets/js/85.420cfd4a.js"><link rel="prefetch" href="/assets/js/86.06ff7ec2.js"><link rel="prefetch" href="/assets/js/87.4dfb234a.js"><link rel="prefetch" href="/assets/js/88.079f044f.js"><link rel="prefetch" href="/assets/js/89.bb76f78f.js"><link rel="prefetch" href="/assets/js/9.8be13208.js"><link rel="prefetch" href="/assets/js/90.ae61c8f3.js"><link rel="prefetch" href="/assets/js/91.8728eb6a.js"><link rel="prefetch" href="/assets/js/92.0d8581e8.js"><link rel="prefetch" href="/assets/js/93.e05baea5.js"><link rel="prefetch" href="/assets/js/94.c661a216.js"><link rel="prefetch" href="/assets/js/95.5414604a.js"><link rel="prefetch" href="/assets/js/96.529def2c.js"><link rel="prefetch" href="/assets/js/97.fb2d6168.js"><link rel="prefetch" href="/assets/js/98.69e544d7.js"><link rel="prefetch" href="/assets/js/99.a7993a79.js">
    <link rel="stylesheet" href="/assets/css/0.styles.92233c96.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="小诺文档中心" class="logo"> <span class="site-name can-hide">小诺文档中心</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://opersdev.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小诺博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/devops/" class="nav-link">DevOps</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">云原生</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/wzdh/" class="nav-link">网址导航</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/opersdev" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/opersdev/docs/img/touxiang.jpg"> <div class="blogger-info"><h3>kevin</h3> <span>运维界的菜鸟</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://opersdev.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小诺博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/devops/" class="nav-link">DevOps</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">云原生</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/wzdh/" class="nav-link">网址导航</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/opersdev" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>shell编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>消息队列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ELK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>自动化运维</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6e7001/" class="sidebar-link">ansible笔记</a></li><li><a href="/pages/2992e6/" class="sidebar-link">gitlab</a></li><li><a href="/pages/00f471/" aria-current="page" class="active sidebar-link">jenkins</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>linux</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/devops/#DevOps" data-v-06225672>DevOps</a></li><li data-v-06225672><a href="/devops/#自动化运维" data-v-06225672>自动化运维</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/opersdev" target="_blank" title="作者" class="beLink" data-v-06225672>xiaonuo</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-06-24</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">jenkins<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h5 id="_1、传统网站部署流程"><a href="#_1、传统网站部署流程" class="header-anchor">#</a> 1、传统网站部署流程</h5> <p>需求》开发》测试》部署》备份》上线》测试</p> <p>MAKE、ANT、MAVEN、Eclipse</p> <p>jenkins部署流程</p> <p>提交代码》测试代码》合并代码构建 》部署(晚上定时发布) 》回滚</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b528852833d.png" alt="image-20210929172824279"></p> <p>Jenkins+Docker+SpringCloud持续集成流程说明</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52885c0c5c.png" alt="image-20210929181105923"></p> <p>Kubernates+Docker+Jenkins持续集成架构图</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b528860d938.png" alt="image-20210929182035446"></p> <p>大致工作流程：手动/自动构建 -&gt; Jenkins 调度 K8S API -＞动态生成 Jenkins Slave pod -＞ Slave pod 拉取 Git 代码／编译／打包镜像 -＞推送到镜像仓库 Harbor -＞ Slave 工作完成，Pod 自动销毁 -＞部署 到测试或生产 Kubernetes平台。（完全自动化，无需人工干预）</p> <p>SonarQube代码审查</p> <h5 id="_2、jenkins安装"><a href="#_2、jenkins安装" class="header-anchor">#</a> 2、jenkins安装</h5> <p>yum -y install java
java -version 版本8.0以上</p> <p>wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins.io/redhat-stable/jenkins.repo
rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
yum -y install jenkins
yum install xorg-x11-server-Xvfb
vim /etc/sysconfig/jenkins
JENKINS_USER=&quot;jenkins&quot;
JENKINS_PORT =&quot;8080&quot;</p> <p>chown -R jenkins.jenkins /var/lib/jenkins/
chown -R jenkins.jenkins /var/log/jenkins/</p> <p>java -jar /usr/lib/jenkins/jenkins.war --httpPort=8888</p> <p>war包下载</p> <p>https://updates.jenkins-ci.org/download/war/</p> <h5 id="_3、基础知识"><a href="#_3、基础知识" class="header-anchor">#</a> 3、基础知识</h5> <p>什么是持续集成(CI-Continuous integration)
持续集成是指多名开发者在开发不同功能代码的过程当中，可以频繁的将代码行合并到一起并切相互不影响工作。</p> <p>什么是持续部署(CD-continuous deployment)
是基于某种工具或平台实现代码自动化的构建、测试和部署到线上环境以实现交付高质量的产品,持续部署在某种程度上代表了一个开发团队的更新迭代速率。</p> <p>什么是持续交付(Continuous Delivery)
持续交付是在持续部署的基础之上，将产品交付到线上环境，因此持续交付是产品价值的一种交付，是产品价值的一种盈利的实现。</p> <p>jenkins是一个开源持续集成工具
1.支持主流软件配置管理，配合实现软件配置管理，持续集成功能
2.主流的运维开发平台，兼容所有主流开发环境
3.插件市场可与海量业内主流开发工具实现集成
4.Job为配置单位与日志管理，使运维与开发人员能协同工作
5.权限管理划分不同job不同角色
6.强大的负载均衡功能，保证我们项目的可靠性</p> <p>freestyle job:
1.需在页面添加模块配置项与参数完成配置
2.每个job仅能实现一个开发功能
3.无法将配置代码化，不利于Job配置迁移与版本控制
4.逻辑相对简单，无需额外学习成本</p> <p>pipeline job:
匹配持续集成与持续交付的概念
1.所有模块，参数配置都可以体现为一个pipeline脚本
2.可以定义多个stage构建一个管道工作集
3.所有配置代码化，方便job配置迁移与版本控制
4.需要pipeline脚本语法基础</p> <h5 id="_4、jenkins-job构建配置"><a href="#_4、jenkins-job构建配置" class="header-anchor">#</a> 4、jenkins job构建配置</h5> <p>1.配置jenkins server 本地gitlab DNS
2.安装git client,curl工具依赖
3.关闭系统git http.sslVerfiy安全认证
4.添加jenkins后台 git client user与email
5.添加jenkins后台 git Credential凭据</p> <h6 id="_4-1-jenkinx配置构建触发器"><a href="#_4-1-jenkinx配置构建触发器" class="header-anchor">#</a> 4.1 jenkinx配置构建触发器</h6> <p>安装插件
git
gitlab hook
Role-based Authorization Strategy</p> <p>openssl rand -hex 12</p> <p>http://jenkins.ops.com/job/testproject-app/build?token=93a09ec625469417d29219c1</p> <p>取消跨站请求伪造保护</p> <p>高版本jenkins不能界面禁用跨站请求伪造保护。</p> <p>禁用跨站请求伪造保护操作如下：</p> <p>修改jenkins的配置文件。vim /etc/sysconfig/jenkins</p> <p>JENKINS_JAVA_OPTIONS=&quot;-Djava.awt.headless=true -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=true&quot;</p> <p>配置后重启jenkins。service jenkins restart</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /var/lib/jenkins/workspace/testproject-app 
ssh 192.168.200.237 &quot;rm -rf /opt/tomcat2&quot;
scp -r tomcat 192.168.200.237:/opt/tomcat2
ssh 192.168.200.237 &quot;java -version&quot;
ssh 192.168.200.237 &quot;mkdir /opt/tomcat2/logs&quot;
ssh 192.168.200.237 &quot;/opt/tomcat2/bin/startup.sh start&quot;


cd /var/lib/jenkins/workspace/testproject-app
tar czvf code.tar.gz *
scp code.tar.gz 192.168.200.212:/data/tomcat/tomcat_appdir/
ssh 192.168.200.212 &quot;systemctl stop tomcat &amp;&amp; rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;
ssh 192.168.200.212 &quot;systemctl start tomcat&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>视图插件
build pipeline</p> <h5 id="_5-docker安装jenkins"><a href="#_5-docker安装jenkins" class="header-anchor">#</a> 5.docker安装jenkins</h5> <p>docker run --name jenkins -u root -p 8083:8080 -p 50000:50000 -d  --restart=always -v /data/jenkins:/var/jenkins_home  jenkins:2.19.3</p> <h5 id="_6-jenkins-pipeline-job编写规范"><a href="#_6-jenkins-pipeline-job编写规范" class="header-anchor">#</a> 6.jenkins pipeline job编写规范</h5> <p>pipeline基础架构
◆所有代码包裹在pipeline{}层内
◆stages{}层用来包含该pipeline所有stage子层
◆stage{}层用来包含具体我们需要编写任务的steps{}子层</p> <p>agent区域
◆agent定义pipeline在哪里运行
可以使用any, none,或具体的Jenkins node主机名等
例:如果我们要特指在node1.上执行,可以写成:
agent {node {label 'node1'}}</p> <p>agent any</p> <p>environment区域
◆&quot;变 量名称=变量值&quot;定义我们的环境变量</p> <p>◆可以定义全局环境变量,应用所有stages任务</p> <p>◆可以定义stage环境变量,应用单独的stage任务</p> <p>script区域(可选)
◆在steps内定义script{}
◆groovy脚本语言
◆用来进行脚本逻辑运算</p> <p>常用steps区域
◆echo: 打印输出
◆sh: 调用Linux系统shell命令
◆git url:调用git模块进行git相关操作</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent <span class="token punctuation">{</span>node <span class="token punctuation">{</span>label <span class="token string">'jenkins-slave1'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    
    environment <span class="token punctuation">{</span>
        JAVA_HOME<span class="token operator">=</span><span class="token interpolation-string"><span class="token string">&quot;/opt/jdk&quot;</span></span>
    <span class="token punctuation">}</span>
         
 stages <span class="token punctuation">{</span> 
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;clone 代码&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		steps<span class="token punctuation">{</span>
             sh <span class="token string">'rm -rf /home/jenkins/workspace/pipeline-test2/*'</span>
        git credentialsId<span class="token punctuation">:</span> <span class="token string">'d8106f36-80b1-4847-a93e-2b88ffa70a31'</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">'https://gitee.com/opstand/cloud.git'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;代码打包&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		steps<span class="token punctuation">{</span>
    	sh <span class="token string">'cd /home/jenkins/workspace/pipeline-test2/ &amp;&amp; tar zcf /opt/code.tar.gz *'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;代码复制&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		steps<span class="token punctuation">{</span>
   		 sh <span class="token string">'cp /opt/code.tar.gz /opt/tomcat8/webapps/'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
     <span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;tomcat重启&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		steps<span class="token punctuation">{</span>
    	sh <span class="token string">'/opt/tomcat8/bin/shutdown.sh &amp;&amp; sleep 10s'</span>
    	sh <span class="token string">'/opt/tomcat8/bin/startup.sh'</span>
        sh <span class="token string">'ps -ef|grep tomcat'</span>
        sh <span class="token string">'ss -tnl'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>jenkins shell命令</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/sh</span>

<span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">whoami</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$user</span> <span class="token operator">==</span> <span class="token string">'deploy'</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
	<span class="token builtin class-name">echo</span> <span class="token string">&quot;Hello, my name is <span class="token variable">$user</span>&quot;</span>
<span class="token keyword">else</span>
	<span class="token builtin class-name">echo</span> <span class="token string">&quot;Sorry, I am not <span class="token variable">$user</span>&quot;</span>
<span class="token keyword">fi</span>

<span class="token function">ip</span> addr

<span class="token function">cat</span> /etc/system-release

<span class="token function">free</span> -m

<span class="token function">df</span> -h

<span class="token assign-left variable">py_cmd</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">which</span> python<span class="token variable">`</span></span>

<span class="token variable">$py_cmd</span> --version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>jenkins集成ansible</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/sh</span>

<span class="token function">ssh</span> root@192.168.200.210 -p <span class="token number">2222</span> <span class="token string">&quot;cat &gt;/tmp/1.sh&lt;&lt;EOF \
#!/bin/bash
ansible --version
ansible-playbook --version
cat /etc/ansible/hosts
ansible web -m command -a <span class="token entity" title="\&quot;">\&quot;</span>ip addr<span class="token entity" title="\&quot;">\&quot;</span>
EOF&quot;</span>

<span class="token function">ssh</span> root@192.168.200.210 -p <span class="token number">2222</span> <span class="token string">&quot;bash /tmp/1.sh&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="_7-pipline-job示例"><a href="#_7-pipline-job示例" class="header-anchor">#</a> 7.pipline job示例</h5> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">node</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;jenkins-slave1&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;clone代码&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
sh <span class="token string">'rm -rf /var/lib/jenkins/workspace/pipeline-test/*'</span>
git branch<span class="token punctuation">:</span> <span class="token string">'develop'</span><span class="token punctuation">,</span> credentialsId<span class="token punctuation">:</span> <span class="token string">'b0c0dd45-e628-44ad-be1c-42693fdedf6c'</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">'git@gitlab.example.com:testgroup/testproject.git'</span>
<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;代码打包&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
sh <span class="token string">'cd /var/lib/jenkins/workspace/pipeline-test/ &amp;&amp; tar czvf code.tar.gz *'</span>
<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;代码复制&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
sh <span class="token string">'scp code.tar.gz 192.168.200.212:/data/tomcat/tomcat_appdir/'</span>

<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;停止tomcat服务&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
sh <span class="token string">'ssh 192.168.200.212 &quot;systemctl stop tomcat&quot;'</span>
<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;代码部署&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
sh <span class="token string">'ssh 192.168.200.212 &quot;rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;'</span>
<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;启动tomcat服务&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
sh <span class="token string">'ssh 192.168.200.212 &quot;systemctl start tomcat&quot;'</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h5 id="jenkinsfile-基础语法"><a href="#jenkinsfile-基础语法" class="header-anchor">#</a> JenkinsFile 基础语法</h5> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token comment">// 前端项目JenkinsFile配置，后端项目配置稍有不同，后面会区分说明</span>
pipeline <span class="token punctuation">{</span>
  agent any
  environment <span class="token punctuation">{</span>
    HOST_TEST <span class="token operator">=</span> <span class="token string">'root@121.41.16.183'</span>
    HOST_ONLINE <span class="token operator">=</span> <span class="token string">'jenkins@39.101.219.110'</span>
    SOURCE_DIR <span class="token operator">=</span> <span class="token string">'dist/*'</span>
    TARGET_DIR <span class="token operator">=</span> <span class="token string">'/data/www/kuaimen-yunying-front'</span>
  <span class="token punctuation">}</span>
  parameters <span class="token punctuation">{</span>
    <span class="token function">choice</span><span class="token punctuation">(</span>
      description<span class="token punctuation">:</span> <span class="token string">'你需要选择哪个环境进行部署 ?'</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">'env'</span><span class="token punctuation">,</span>
      choices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'测试环境'</span><span class="token punctuation">,</span> <span class="token string">'线上环境'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'本次更新内容?'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  triggers <span class="token punctuation">{</span>
    <span class="token function">GenericTrigger</span><span class="token punctuation">(</span>
     genericVariables<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token string">'ref'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'$.ref'</span><span class="token punctuation">]</span>
     <span class="token punctuation">]</span><span class="token punctuation">,</span>
     causeString<span class="token punctuation">:</span> <span class="token string">'Triggered on $ref'</span><span class="token punctuation">,</span>
     token<span class="token punctuation">:</span> <span class="token string">'runcenter-front-q1w2e3r4t5'</span><span class="token punctuation">,</span>
     tokenCredentialId<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
     printContributedVariables<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
     printPostContent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
     silentResponse<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
     regexpFilterText<span class="token punctuation">:</span> <span class="token string">'$ref'</span><span class="token punctuation">,</span>
     regexpFilterExpression<span class="token punctuation">:</span> <span class="token string">'refs/heads/'</span> <span class="token operator">+</span> BRANCH_NAME
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  stages <span class="token punctuation">{</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'获取git commit message'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     steps <span class="token punctuation">{</span>
       script <span class="token punctuation">{</span>
         env<span class="token punctuation">.</span>GIT_COMMIT_MSG <span class="token operator">=</span> sh <span class="token punctuation">(</span>script<span class="token punctuation">:</span> <span class="token string">'git log -1 --pretty=%B ${GIT_COMMIT}'</span><span class="token punctuation">,</span> returnStdout<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'打包'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      steps <span class="token punctuation">{</span>
        <span class="token function">nodejs</span><span class="token punctuation">(</span><span class="token string">'nodejs-12.16'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          echo <span class="token string">'开始安装依赖'</span>
          sh <span class="token string">'yarn'</span>
          echo <span class="token string">'开始打包'</span>
          sh <span class="token string">'yarn run build'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'部署'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      when <span class="token punctuation">{</span>
        expression <span class="token punctuation">{</span>
          params<span class="token punctuation">.</span>env <span class="token operator">==</span> <span class="token string">'测试环境'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      steps <span class="token punctuation">{</span>
        <span class="token function">sshagent</span><span class="token punctuation">(</span>credentials<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'km-test2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sh <span class="token interpolation-string"><span class="token string">&quot;ssh -o StrictHostKeyChecking=no </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">HOST_TEST</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> uname -a&quot;</span></span>
          sh <span class="token interpolation-string"><span class="token string">&quot;scp -r </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">SOURCE_DIR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">HOST_TEST</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">TARGET_DIR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
          sh <span class="token string">'echo &quot;部署成功~&quot;'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'发布'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      when <span class="token punctuation">{</span>
        expression <span class="token punctuation">{</span>
          params<span class="token punctuation">.</span>env <span class="token operator">==</span> <span class="token string">'线上环境'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      steps <span class="token punctuation">{</span>
        <span class="token function">sshagent</span><span class="token punctuation">(</span>credentials<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'km-online'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sh <span class="token interpolation-string"><span class="token string">&quot;ssh -o StrictHostKeyChecking=no </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">HOST_ONLINE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> uname -a&quot;</span></span>
          sh <span class="token interpolation-string"><span class="token string">&quot;scp -r </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">SOURCE_DIR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">HOST_ONLINE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">TARGET_DIR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
          sh <span class="token string">'echo &quot;发布成功~&quot;'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  post <span class="token punctuation">{</span>
    success <span class="token punctuation">{</span>
      dingtalk <span class="token punctuation">(</span>
        robot<span class="token punctuation">:</span> <span class="token string">'77d4c82d-3794-4583-bc7f-556902fee6b0'</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token string">'MARKDOWN'</span><span class="token punctuation">,</span>
        atAll<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'你有新的消息，请注意查收'</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span><span class="token punctuation">[</span>
          <span class="token string">'# 运营管理系统发布通知'</span><span class="token punctuation">,</span>
          <span class="token string">'---'</span><span class="token punctuation">,</span>
          <span class="token string">'#### **所属：前端**'</span><span class="token punctuation">,</span>
          <span class="token interpolation-string"><span class="token string">&quot;#### **构建任务：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">env<span class="token punctuation">.</span>BUILD_DISPLAY_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
          <span class="token interpolation-string"><span class="token string">&quot;#### **Git commit：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">env<span class="token punctuation">.</span>GIT_COMMIT_MSG</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
          <span class="token interpolation-string"><span class="token string">&quot;#### **本次更新内容：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">params<span class="token punctuation">.</span>update</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
          <span class="token interpolation-string"><span class="token string">&quot;#### **部署环境：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">params<span class="token punctuation">.</span>env</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**&quot;</span></span><span class="token punctuation">,</span>
          <span class="token string">'#### **构建结果：成功**'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br></div></div><ul><li>pipeline 必须在最外层</li> <li>agent 定义了在哪个环境里执行，默认any</li> <li>stages 阶段，标识构建流程的标签块，子节点是stage</li> <li>steps 执行步骤</li> <li>post 所有阶段执行完成后执行一些逻辑</li> <li>when 可以控制该阶段是否执行</li> <li>environment 环境变量，在这里定义的变量，JenkinsFile的任何地方都可以访问</li> <li>tools 项目使用到的构建工具，声明系统配置中已经定义好的工具，如maven</li> <li>parameters 定义参数，可以提供用户输入或者选择</li> <li>post 构建结束后会执行这里，有success、failure、success，本示例将在success（构建成功时）发起钉钉通知</li></ul> <h5 id="_8-shell自动发布脚本"><a href="#_8-shell自动发布脚本" class="header-anchor">#</a> 8.shell自动发布脚本</h5> <p>自动上传war包</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /var/jenkins_home/workspace/cjpt_222_sd/web/target
<span class="token function">ssh</span> <span class="token number">192.168</span>.1.222 <span class="token string">&quot;systemctl stop tomcat &amp;&amp; rm -f /opt/tomcat8/webapps/web.war &amp;&amp; rm -rf /opt/tomcat8/webapps/web&quot;</span>
<span class="token function">scp</span> *.war <span class="token number">192.168</span>.1.222:/opt/tomcat8/webapps/web.war
<span class="token function">ssh</span> <span class="token number">192.168</span>.1.222 <span class="token string">&quot;systemctl start tomcat&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="_9-jenkins-设置中文显示"><a href="#_9-jenkins-设置中文显示" class="header-anchor">#</a> 9.jenkins 设置中文显示</h5> <p>这里使用的方法是安装中文语言包，安装的插件名称是：Localization: Chinese (Simplified)
1.在插件管理，搜索 Localization: Chinese (Simplified)，然后点击Install without restart</p> <p>好记性不如烂笔头,仅用来记录</p> <h5 id="_10-jenkins构建maven项目"><a href="#_10-jenkins构建maven项目" class="header-anchor">#</a> 10.jenkins构建maven项目</h5> <p>一、linux的环境</p> <p>jdk 、maven 、tomcat版本按照所定需求安装好</p> <p>二、jenkins安装</p> <p>这里就忽略了</p> <p>三、jenkins所需要的插件</p> <p>Deploy to container</p> <p>Maven Intergration plugin</p> <p>四、全局工具配置</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b528864dc26.jpg" alt="img"></p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b528868a662.jpg" alt="img"></p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52886c0aec.jpg" alt="img"></p> <p>五、创建任务</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b528870e069.jpg" alt="img"></p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b5288752375.jpg" alt="img"></p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b528879190f.jpg" alt="img"></p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52887dabd4.jpg" alt="img"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>打开tomcat下conf/tomcat-users.xml，在&lt;/tomcat-users&gt;之前增加以下配置:

&lt;role rolename=&quot;manager&quot;/&gt;

&lt;role rolename=&quot;manager-gui&quot;/&gt;

&lt;role rolename=&quot;manager-script&quot;/&gt;

&lt;role rolename=&quot;manager-status&quot;/&gt;

&lt;user username=&quot;xxx&quot; password=&quot;xxxx&quot; roles=&quot;tomcat,admin-gui,admin,manager,manager-gui,manager-script&quot;/&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b5288829036.jpg" alt="img"></p> <p>之后点击构建得到以下结果就是完满成功了~</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b5288866cfc.jpg" alt="img"></p> <p>如果Jenkins报错：The username you provided is not allowed to use the text-based Tomcat Manager (error 403)：</p> <p>在tomcat目录修改两个文件！</p> <p>webapps/manager/META-INF/context.xml</p> <p>webapps/host-manager/META-INF/context.xml</p> <p>将只允许本机访问的限制注释掉即可，</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52888a3c60.jpg" alt="img"></p> <p>如果jenkins报错：</p> <p>ERROR: Maven JVM terminated unexpectedly with exit code 137</p> <p>1、查看内存使用情况：free -m</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52888ddcda.jpg" alt="img"></p> <p>2、创建虚拟内存磁盘卷</p> <p>mkdir /swap</p> <p>dd if=/dev/zero of=/swap/swapadd bs=1024 count=2024288</p> <p>3、将磁盘卷转为虚拟内存卷</p> <p>mkswap /swap/swapadd</p> <p>4、启用虚拟内存服务</p> <p>swapon /swap/swapadd</p> <p>5、再次查看内存情况</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b528892466e.jpg" alt="img"></p> <h5 id="_11-jenkins版本回滚"><a href="#_11-jenkins版本回滚" class="header-anchor">#</a> 11.jenkins版本回滚</h5> <h5 id="一、新建一个自由风格项目"><a href="#一、新建一个自由风格项目" class="header-anchor">#</a> 一、新建一个自由风格项目</h5> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-a108ab1f36ecd0f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/961/format/webp" alt="img"></p> <p>image.png</p> <h5 id="二、配置参数化构建过程"><a href="#二、配置参数化构建过程" class="header-anchor">#</a> 二、配置参数化构建过程</h5> <ol><li><p>添加选项参数</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-2e02048f5c44c73e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080/format/webp" alt="img"></p> <p>image.png</p> <p>填入以下内容</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-d92b90cf02394370.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/932/format/webp" alt="img"></p> <p>image.png</p> <p>2.添加字符参数</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-fb7d94687c85fa8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/981/format/webp" alt="img"></p> <p>image.png</p></li></ol> <h5 id="三、配置svn"><a href="#三、配置svn" class="header-anchor">#</a> 三、配置SVN</h5> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-5f07deb042e0775b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1116/format/webp" alt="img"></p> <p>image.png</p> <h5 id="四、配置构建步骤"><a href="#四、配置构建步骤" class="header-anchor">#</a> 四、配置构建步骤</h5> <h6 id="_1-maven打包配置"><a href="#_1-maven打包配置" class="header-anchor">#</a> 1. maven打包配置</h6> <ul><li><p>选择调用顶层Maven目标，Maven版本之前已经在全局工具配置中设置过，目标中填入打包命令</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-367ecfbc81f77708.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/940/format/webp" alt="img"></p> <p>image.png</p></li></ul> <h6 id="_2-执行shell配置"><a href="#_2-执行shell配置" class="header-anchor">#</a> 2. 执行shell配置</h6> <ul><li><p>此脚本为打包备份，回滚脚本</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-757547f8453fdfab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1029/format/webp" alt="img"></p> <p>image.png</p> <p>填入以下脚本</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-a90ca577c7fd6e40.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/973/format/webp" alt="img"></p> <p>备份回滚脚本</p></li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">case</span> <span class="token variable">$Status</span>  <span class="token keyword">in</span>
  Deploy<span class="token punctuation">)</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Status:<span class="token variable">$Status</span>&quot;</span>
    <span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${WORKSPACE}</span>/bak/<span class="token variable">${BUILD_NUMBER}</span>&quot;</span>      <span class="token comment">#创建每次要备份的目录</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -d <span class="token variable">$path</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;The files is already  exists &quot;</span>
    <span class="token keyword">else</span>
        <span class="token function">mkdir</span> -p  <span class="token variable">$path</span>
    <span class="token keyword">fi</span>
    <span class="token punctuation">\</span>cp -f <span class="token variable">${WORKSPACE}</span>/target/*.war <span class="token variable">$path</span>        <span class="token comment">#将打包好的war包备份到相应目录,覆盖已存在的目标</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;Completing!&quot;</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  Rollback<span class="token punctuation">)</span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;Status:<span class="token variable">$Status</span>&quot;</span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;Version:<span class="token variable">$Version</span>&quot;</span>
      <span class="token builtin class-name">cd</span> <span class="token variable">${WORKSPACE}</span>/bak/<span class="token variable">$Version</span>            <span class="token comment">#进入备份目录</span>
      <span class="token punctuation">\</span>cp -f *.war <span class="token variable">${WORKSPACE}</span>/target/       <span class="token comment">#将备份拷贝到程序打包目录中，并覆盖之前的war包</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  *<span class="token punctuation">)</span>
  <span class="token builtin class-name">exit</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li><p>这样发布后以后，就会备份如下</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-8eb71eb8e32b149f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/438/format/webp" alt="img"></p> <p>image.png</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-48e84ec4ca604b12.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/509/format/webp" alt="img"></p> <p>image.png</p></li></ul> <h6 id="_3-定期删除脚本"><a href="#_3-定期删除脚本" class="header-anchor">#</a> 3. 定期删除脚本</h6> <ul><li><p>项目备份不可能无限制备份，这样很快就会占满磁盘，所以我们必须有清除老旧备份的机制。此处配置一个脚本，每次发布都执行一次，判断备份数是否超过5个，如果超过，则删除老旧备份，只保留最新的5个。</p></li> <li><p>再添加一个执行shell步骤，填入以下脚本，其中备份数量可以自行修改减小或加大</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-6f94e72e5e418530.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/950/format/webp" alt="img"></p> <p>删除老旧备份脚本</p></li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">ReservedNum</span><span class="token operator">=</span><span class="token number">5</span>  <span class="token comment">#保留文件数</span>
<span class="token assign-left variable">FileDir</span><span class="token operator">=</span><span class="token variable">${WORKSPACE}</span>/bak/
<span class="token assign-left variable">date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">&quot;+%Y%m%d-%H%M%S&quot;</span><span class="token variable">)</span></span>

<span class="token builtin class-name">cd</span> <span class="token variable">$FileDir</span>   <span class="token comment">#进入备份目录</span>
<span class="token assign-left variable">FileNum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -l <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'^d'</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span>   <span class="token comment">#当前有几个文件夹，即几个备份</span>

<span class="token keyword">while</span><span class="token variable"><span class="token punctuation">((</span> $FileNum <span class="token operator">&gt;</span> $ReservedNum<span class="token punctuation">))</span></span>
<span class="token keyword">do</span>
    <span class="token assign-left variable">OldFile</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -rt <span class="token operator">|</span> <span class="token function">head</span> -1<span class="token variable">)</span></span>         <span class="token comment">#获取最旧的那个备份文件夹</span>
    <span class="token builtin class-name">echo</span>  <span class="token variable">$date</span> <span class="token string">&quot;Delete File:&quot;</span><span class="token variable">$OldFile</span>
    <span class="token function">rm</span> -rf <span class="token variable">$FileDir</span>/<span class="token variable">$OldFile</span>
    <span class="token builtin class-name">let</span> <span class="token string">&quot;FileNum--&quot;</span>
<span class="token keyword">done</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="五、配置发送到远程tomcat目录"><a href="#五、配置发送到远程tomcat目录" class="header-anchor">#</a> 五、配置发送到远程tomcat目录</h5> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-c7beb037bddad4f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1055/format/webp" alt="img"></p> <p>image.png</p> <p>其中Source files要注意配置正确，否则发送不了war包，我的jenkins该项目的workspace如下：</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-819b6ed8eb89107e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/810/format/webp" alt="img"></p> <p>image.png</p> <h6 id="六、发布"><a href="#六、发布" class="header-anchor">#</a> 六、发布</h6> <ul><li>回到项目主界面，点击Build with Parameters</li></ul> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-4fef7f366d2c4582.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1083/format/webp" alt="img"></p> <ul><li><p>发布选择Deploy---&gt;开始构建，即可开始发布。</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-fe8a4b1e7436a3c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/999/format/webp" alt="img"></p> <p>image.png</p></li> <li><p>回滚选择Rollback---&gt;输入回滚版本----&gt;开始构建，版本号从构建历史中选择一个输入</p> <p><img src="https:////upload-images.jianshu.io/upload_images/7802645-1461ea688e7b5d62.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1105/format/webp" alt="img"></p></li></ul> <h5 id="_12-关于execute-shell"><a href="#_12-关于execute-shell" class="header-anchor">#</a> 12.关于execute shell</h5> <p>请在“Execute shell”构建步骤中添加以下行。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token hashbang comment">#!/bin/sh</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在让我解释一下为什么我们需要这行“Execute Shell”构建作业的原因。</p> <p>默认情况下，Jenkins采取<code>/bin/sh -xe</code>这种方式<code>-x</code>将打印每一个命令。另一个选项<code>-e</code>，当任何命令以非零值（当任何命令失败时）退出代码时，这会导致shell立即停止运行脚本。</p> <p>所以通过添加<code>#!/bin/sh</code>将让你执行没有选择。</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/2992e6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">gitlab</div></a> <a href="/pages/4d3009/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">firewalld</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/2992e6/" class="prev">gitlab</a></span> <span class="next"><a href="/pages/4d3009/">firewalld</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/613b69/"><div>
            postgresql安装
            <!----></div></a> <span class="date">06-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/8ae632/"><div>
            oracle笔记
            <!----></div></a> <span class="date">06-24</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/765fc1/"><div>
            opengauss笔记
            <!----></div></a> <span class="date">06-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:48211701@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/opersdev" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://all.xnuo.top" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>kevin | <a href="https://github.com/opersdev" target="_blank">小诺运维</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.38f1b0a4.js" defer></script><script src="/assets/js/2.6beb1dc7.js" defer></script><script src="/assets/js/30.23c0524a.js" defer></script>
  </body>
</html>
