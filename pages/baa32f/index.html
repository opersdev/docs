<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx | 小诺文档中心</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <meta name="description" content="运维技术文档,mysql,k8s,docker,linux,shell,python等技术文章。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="运维技术文档,mysql,k8s,docker,linux,shell,python,技术文档,学习,面试,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.92233c96.css" as="style"><link rel="preload" href="/assets/js/app.38f1b0a4.js" as="script"><link rel="preload" href="/assets/js/2.6beb1dc7.js" as="script"><link rel="preload" href="/assets/js/17.1da2b6ae.js" as="script"><link rel="prefetch" href="/assets/js/10.4365b950.js"><link rel="prefetch" href="/assets/js/100.8dac6c81.js"><link rel="prefetch" href="/assets/js/101.a5556ac1.js"><link rel="prefetch" href="/assets/js/102.e3ff38b9.js"><link rel="prefetch" href="/assets/js/103.3bcf44f5.js"><link rel="prefetch" href="/assets/js/104.6d56e53e.js"><link rel="prefetch" href="/assets/js/105.4fc9762e.js"><link rel="prefetch" href="/assets/js/106.f507561a.js"><link rel="prefetch" href="/assets/js/107.6c94c756.js"><link rel="prefetch" href="/assets/js/108.f7ff1945.js"><link rel="prefetch" href="/assets/js/109.aeb1e532.js"><link rel="prefetch" href="/assets/js/11.fe1ff844.js"><link rel="prefetch" href="/assets/js/110.dda67b83.js"><link rel="prefetch" href="/assets/js/111.5b990f24.js"><link rel="prefetch" href="/assets/js/112.0a27d3a0.js"><link rel="prefetch" href="/assets/js/113.972cd001.js"><link rel="prefetch" href="/assets/js/114.875814a1.js"><link rel="prefetch" href="/assets/js/115.ec235d59.js"><link rel="prefetch" href="/assets/js/116.03bd2386.js"><link rel="prefetch" href="/assets/js/117.68765825.js"><link rel="prefetch" href="/assets/js/118.9d6d0255.js"><link rel="prefetch" href="/assets/js/119.ff84a82f.js"><link rel="prefetch" href="/assets/js/12.aa21f453.js"><link rel="prefetch" href="/assets/js/120.20639785.js"><link rel="prefetch" href="/assets/js/121.6c546150.js"><link rel="prefetch" href="/assets/js/122.48e85de5.js"><link rel="prefetch" href="/assets/js/123.fc931745.js"><link rel="prefetch" href="/assets/js/124.797d5fda.js"><link rel="prefetch" href="/assets/js/125.b23a31c7.js"><link rel="prefetch" href="/assets/js/126.d7a182fd.js"><link rel="prefetch" href="/assets/js/127.167a63d6.js"><link rel="prefetch" href="/assets/js/128.878d4a7e.js"><link rel="prefetch" href="/assets/js/129.a8957dfa.js"><link rel="prefetch" href="/assets/js/13.161be064.js"><link rel="prefetch" href="/assets/js/130.3961a295.js"><link rel="prefetch" href="/assets/js/131.9c4e7a56.js"><link rel="prefetch" href="/assets/js/132.41d26584.js"><link rel="prefetch" href="/assets/js/133.6d91047e.js"><link rel="prefetch" href="/assets/js/134.121ecf0e.js"><link rel="prefetch" href="/assets/js/135.6e30234c.js"><link rel="prefetch" href="/assets/js/136.6fab7ce4.js"><link rel="prefetch" href="/assets/js/137.209af36e.js"><link rel="prefetch" href="/assets/js/138.660f236e.js"><link rel="prefetch" href="/assets/js/139.81c29d19.js"><link rel="prefetch" href="/assets/js/14.d0f13635.js"><link rel="prefetch" href="/assets/js/140.d8f594ca.js"><link rel="prefetch" href="/assets/js/141.89fbea1c.js"><link rel="prefetch" href="/assets/js/142.643bccec.js"><link rel="prefetch" href="/assets/js/143.f270bffc.js"><link rel="prefetch" href="/assets/js/144.cf6f4c9a.js"><link rel="prefetch" href="/assets/js/145.093699b5.js"><link rel="prefetch" href="/assets/js/146.876575d0.js"><link rel="prefetch" href="/assets/js/147.dc120635.js"><link rel="prefetch" href="/assets/js/148.4a3ba80f.js"><link rel="prefetch" href="/assets/js/149.4afb7469.js"><link rel="prefetch" href="/assets/js/15.af46dbb5.js"><link rel="prefetch" href="/assets/js/150.4eb38cf2.js"><link rel="prefetch" href="/assets/js/151.4fe6a931.js"><link rel="prefetch" href="/assets/js/16.4cbf8beb.js"><link rel="prefetch" href="/assets/js/18.0402bfbf.js"><link rel="prefetch" href="/assets/js/19.230bfe93.js"><link rel="prefetch" href="/assets/js/20.0d20ddb2.js"><link rel="prefetch" href="/assets/js/21.9dbdbc8b.js"><link rel="prefetch" href="/assets/js/22.1410508d.js"><link rel="prefetch" href="/assets/js/23.63089216.js"><link rel="prefetch" href="/assets/js/24.e6fe9306.js"><link rel="prefetch" href="/assets/js/25.1240d0c9.js"><link rel="prefetch" href="/assets/js/26.0f4fb46d.js"><link rel="prefetch" href="/assets/js/27.5b193a22.js"><link rel="prefetch" href="/assets/js/28.90e27733.js"><link rel="prefetch" href="/assets/js/29.cdb75f6c.js"><link rel="prefetch" href="/assets/js/3.1229de89.js"><link rel="prefetch" href="/assets/js/30.23c0524a.js"><link rel="prefetch" href="/assets/js/31.bc292e1e.js"><link rel="prefetch" href="/assets/js/32.79645dcf.js"><link rel="prefetch" href="/assets/js/33.53e29142.js"><link rel="prefetch" href="/assets/js/34.7ce01d2e.js"><link rel="prefetch" href="/assets/js/35.bcdc888c.js"><link rel="prefetch" href="/assets/js/36.00ce19aa.js"><link rel="prefetch" href="/assets/js/37.e53fea30.js"><link rel="prefetch" href="/assets/js/38.1b84e50f.js"><link rel="prefetch" href="/assets/js/39.ed0470cb.js"><link rel="prefetch" href="/assets/js/4.93dbb352.js"><link rel="prefetch" href="/assets/js/40.010f2420.js"><link rel="prefetch" href="/assets/js/41.7aefa9d2.js"><link rel="prefetch" href="/assets/js/42.eadeaa1f.js"><link rel="prefetch" href="/assets/js/43.012419aa.js"><link rel="prefetch" href="/assets/js/44.aa86bffd.js"><link rel="prefetch" href="/assets/js/45.b7ce8c1a.js"><link rel="prefetch" href="/assets/js/46.bd51c47b.js"><link rel="prefetch" href="/assets/js/47.71d2a52e.js"><link rel="prefetch" href="/assets/js/48.71b9430b.js"><link rel="prefetch" href="/assets/js/49.d92deee5.js"><link rel="prefetch" href="/assets/js/5.9228d2a8.js"><link rel="prefetch" href="/assets/js/50.2827e7a9.js"><link rel="prefetch" href="/assets/js/51.94c41d82.js"><link rel="prefetch" href="/assets/js/52.73681932.js"><link rel="prefetch" href="/assets/js/53.4db7ebcf.js"><link rel="prefetch" href="/assets/js/54.8e6699ab.js"><link rel="prefetch" href="/assets/js/55.3d832a8c.js"><link rel="prefetch" href="/assets/js/56.43282683.js"><link rel="prefetch" href="/assets/js/57.ea8d4f37.js"><link rel="prefetch" href="/assets/js/58.12ff8ca5.js"><link rel="prefetch" href="/assets/js/59.47100612.js"><link rel="prefetch" href="/assets/js/6.341b2c5d.js"><link rel="prefetch" href="/assets/js/60.914e7e2d.js"><link rel="prefetch" href="/assets/js/61.d9414480.js"><link rel="prefetch" href="/assets/js/62.a3747f73.js"><link rel="prefetch" href="/assets/js/63.1a2e54c1.js"><link rel="prefetch" href="/assets/js/64.d9f9224a.js"><link rel="prefetch" href="/assets/js/65.53e3f7bd.js"><link rel="prefetch" href="/assets/js/66.92d44566.js"><link rel="prefetch" href="/assets/js/67.67aba1d2.js"><link rel="prefetch" href="/assets/js/68.acce7dfb.js"><link rel="prefetch" href="/assets/js/69.3dacbd45.js"><link rel="prefetch" href="/assets/js/7.3d063b98.js"><link rel="prefetch" href="/assets/js/70.b40c0f61.js"><link rel="prefetch" href="/assets/js/71.51b34635.js"><link rel="prefetch" href="/assets/js/72.498f4ff0.js"><link rel="prefetch" href="/assets/js/73.b22c0978.js"><link rel="prefetch" href="/assets/js/74.823f2a12.js"><link rel="prefetch" href="/assets/js/75.d24d261d.js"><link rel="prefetch" href="/assets/js/76.44db605e.js"><link rel="prefetch" href="/assets/js/77.efce42e9.js"><link rel="prefetch" href="/assets/js/78.11405a06.js"><link rel="prefetch" href="/assets/js/79.9f0076d7.js"><link rel="prefetch" href="/assets/js/8.812a9a47.js"><link rel="prefetch" href="/assets/js/80.4fc1dc52.js"><link rel="prefetch" href="/assets/js/81.f8963444.js"><link rel="prefetch" href="/assets/js/82.627d5503.js"><link rel="prefetch" href="/assets/js/83.49c45765.js"><link rel="prefetch" href="/assets/js/84.b2045805.js"><link rel="prefetch" href="/assets/js/85.420cfd4a.js"><link rel="prefetch" href="/assets/js/86.06ff7ec2.js"><link rel="prefetch" href="/assets/js/87.4dfb234a.js"><link rel="prefetch" href="/assets/js/88.079f044f.js"><link rel="prefetch" href="/assets/js/89.bb76f78f.js"><link rel="prefetch" href="/assets/js/9.8be13208.js"><link rel="prefetch" href="/assets/js/90.ae61c8f3.js"><link rel="prefetch" href="/assets/js/91.8728eb6a.js"><link rel="prefetch" href="/assets/js/92.0d8581e8.js"><link rel="prefetch" href="/assets/js/93.e05baea5.js"><link rel="prefetch" href="/assets/js/94.c661a216.js"><link rel="prefetch" href="/assets/js/95.5414604a.js"><link rel="prefetch" href="/assets/js/96.529def2c.js"><link rel="prefetch" href="/assets/js/97.fb2d6168.js"><link rel="prefetch" href="/assets/js/98.69e544d7.js"><link rel="prefetch" href="/assets/js/99.a7993a79.js">
    <link rel="stylesheet" href="/assets/css/0.styles.92233c96.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="小诺文档中心" class="logo"> <span class="site-name can-hide">小诺文档中心</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://opersdev.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小诺博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/devops/" class="nav-link">DevOps</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">云原生</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/wzdh/" class="nav-link">网址导航</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/opersdev" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/opersdev/docs/img/touxiang.jpg"> <div class="blogger-info"><h3>kevin</h3> <span>运维界的菜鸟</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://opersdev.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小诺博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/devops/" class="nav-link">DevOps</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">云原生</a></div><div class="nav-item"><a href="/technology/" class="nav-link">技术</a></div><div class="nav-item"><a href="/more/" class="nav-link">更多</a></div><div class="nav-item"><a href="/wzdh/" class="nav-link">网址导航</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/opersdev" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>shell编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>消息队列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>web</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/baa32f/" aria-current="page" class="active sidebar-link">nginx</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/2b9364/" class="sidebar-link">nginx</a></li><li><a href="/pages/88bfb3/" class="sidebar-link">Nginx_day01</a></li><li><a href="/pages/93d0ce/" class="sidebar-link">Nginx_day02</a></li><li><a href="/pages/5930e0/" class="sidebar-link">Nginx_day03</a></li><li><a href="/pages/4c1480/" class="sidebar-link">Nginx_day04</a></li><li><a href="/pages/d2951b/" class="sidebar-link">Nginx_day05</a></li><li><a href="/pages/cfd070/" class="sidebar-link">nginx配置文件模板</a></li><li><a href="/pages/5d9ccf/" class="sidebar-link">php笔记</a></li><li><a href="/pages/eddd8c/" class="sidebar-link">tomcat</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ELK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>自动化运维</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>linux</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/devops/#DevOps" data-v-06225672>DevOps</a></li><li data-v-06225672><a href="/devops/#web" data-v-06225672>web</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/opersdev" target="_blank" title="作者" class="beLink" data-v-06225672>xiaonuo</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-06-24</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">nginx<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h4 id="安装nginx"><a href="#安装nginx" class="header-anchor">#</a> 安装nginx</h4> <p>安装pcre ，perl兼容正则表达式</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> pcre pcre-devel openssl-devel gcc -y

<span class="token function">useradd</span> www -s /sbin/nologin -M
<span class="token builtin class-name">cd</span> nginx-1.16
./configure --prefix<span class="token operator">=</span>/opt/nginx --user<span class="token operator">=</span>www --group<span class="token operator">=</span>www --with-http_ssl_module --with-http_stub_status_module --with-stream

--user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --prefix<span class="token operator">=</span>/workspace/prod/app/nginx --with-stream

<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> 
/opt/nginx/sbin/nginx -c /opt/nginx/conf/nginx.conf
./nginx -s reload

<span class="token function">vim</span> /etc/profile
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/opt/nginx/sbin:<span class="token environment constant">$PATH</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/opt/php/bin:<span class="token environment constant">$PATH</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>编绎选项</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic' --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="nginx重定向"><a href="#nginx重定向" class="header-anchor">#</a> nginx重定向</h4> <h5 id="_2-1-rewrite重定向"><a href="#_2-1-rewrite重定向" class="header-anchor">#</a> 2.1 rewrite重定向</h5> <p>url重写是指通过配置conf文件，以让网站的url中达到某种状态时则定向/跳转到某个规则，比如常见的伪静态、301重定向、浏览器定向等</p> <p>rewrite语法
在配置文件的server块中写，如：</p> <p>server {
rewrite 规则 定向路径 重写类型;
}
规则：可以是字符串或者正则来表示想匹配的目标url
定向路径：表示匹配到规则后要定向的路径，如果规则里有正则，则可以使用$index来表示正则里的捕获分组
重写类型：
last ：相当于Apache里德(L)标记，表示完成rewrite，浏览器地址栏URL地址不变
break；本条规则匹配完成后，终止匹配，不再匹配后面的规则，浏览器地址栏URL地址不变
redirect：返回302临时重定向，浏览器地址会显示跳转后的URL地址
permanent：返回301永久重定向，浏览器地址栏会显示跳转后的URL地址</p> <h5 id="_2-2-重定向所有请求到特定网址"><a href="#_2-2-重定向所有请求到特定网址" class="header-anchor">#</a> 2.2 重定向所有请求到特定网址</h5> <p>这将所有传入请求重定向域名给url http://anotherdomain.com/dir1/index.php，如下配置。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> 192.168.1.100:80</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> mydomain.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> http://anotherdomain.com/dir1/index.php</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="_2-3-重定向所有请求其他域名"><a href="#_2-3-重定向所有请求其他域名" class="header-anchor">#</a> 2.3 重定向所有请求其他域名</h5> <p>这将在域名中的所有传入的请求重定向到另一个域名（http://anotherdomain.com/）与相应的请求的URL和查询字符串。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> 192.168.1.100:80</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> mydomain.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> http://anotherdomain.com<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="_2-4-将请求重定向与特定协议"><a href="#_2-4-将请求重定向与特定协议" class="header-anchor">#</a> 2.4  将请求重定向与特定协议</h5> <p>这将在域名中的所有传入的请求重定向到另一个域名（http://anotherdomain.com/）与相应的请求的URL和查询字符串。它也将使用重定向的URL相同的协议。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> 192.168.1.100:80</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> mydomain.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> <span class="token variable">$scheme</span>://anotherdomain.com<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>域名 www.taobao.com 跳转到www.baidu.com</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> www.taobao.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*) http://www.baidu.com/<span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="nginx代理参数"><a href="#nginx代理参数" class="header-anchor">#</a> nginx代理参数</h4> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span> <span class="token comment">#获取真实ip</span>
<span class="token comment">#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; #获取代理者的真实ip</span>


<span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">256m</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">client_body_buffer_size</span> <span class="token number">128k</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">proxy_connect_timeout</span> <span class="token number">90</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_send_timeout</span> <span class="token number">90</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">90</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_buffer_size</span> <span class="token number">4k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_buffers</span> <span class="token number">4</span> <span class="token number">32k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_busy_buffers_size</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_temp_file_write_size</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>跳转加端口
proxy_set_header Host $host:$proxy_port;</p> <h4 id="nginx屏蔽客户端浏览器"><a href="#nginx屏蔽客户端浏览器" class="header-anchor">#</a> nginx屏蔽客户端浏览器</h4> <p>搞过前端的估计都碰到最头疼的问题就是浏览器兼容性问题了，特别是针对IE浏览器。往往前端为了省事就搞一个页面提示用户升级浏览器或者显示简单的静态页面。那接下来就需要运维来配置nginx rewrite规则了。</p> <p>在这里直接贴出配置实例</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
<span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">server_name</span> xxx.xxx.com</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">root</span>   /www</span> <span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">if</span> ( <span class="token variable">$http_user_agent</span> ~* “MSIE [6-9].[0-9]”)</span> <span class="token punctuation">{</span>
<span class="token directive"><span class="token keyword">rewrite</span>   /ie.html break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>解释一下上面的配置</p> <p>$http_user_agent  客户端agent信息（这个是浏览器的标识，如果你开了访问日志的话，可以去看一下。每种浏览器的标识可能都不一样。)</p> <p>~*  使用正则表达式，并且不区分大小写</p> <p>MSIE [6,7].[0-9]   MSIE-IE浏览器的标识，这里匹配的是IE浏览器在版本在6到9的，例如6.1,7.0,8.2等等···</p> <p>rewrite   /ie6.html   只要匹配则返回指定的静态页面</p> <p>break 停止执行当前这一轮的ngx_http_rewrite_module指令集</p> <p>如果需要验证是否生效的话，这里提供一个比较方便的工具 IETester，可以模拟IE任意版本的浏览器来测试</p> <h4 id="logrotate日志切割"><a href="#logrotate日志切割" class="header-anchor">#</a> logrotate日志切割</h4> <p>/var/log/nginx/*.log {
weekly
missingok
rotate 52
compress
delaycompress
notifempty
create 0640 www-data adm
sharedscripts
prerotate
if [ -d /etc/logrotate.d/httpd-prerotate ]; then <br>
run-parts /etc/logrotate.d/httpd-prerotate; <br>
fi <br>
endscript
postrotate
[ -s /run/nginx.pid ] &amp;&amp; kill -USR1 <code>cat /run/nginx.pid</code>
endscript
}</p> <h4 id="nginx启动脚本"><a href="#nginx启动脚本" class="header-anchor">#</a> nginx启动脚本</h4> <h5 id="_6-1-centos6启动脚本"><a href="#_6-1-centos6启动脚本" class="header-anchor">#</a> 6.1 centos6启动脚本</h5> <p>#!/bin/bash</p> <h1 id=""><a href="#" class="header-anchor">#</a></h1> <p>nginx - this script starts and stops the nginx daemin</p> <h1 id="-2"><a href="#-2" class="header-anchor">#</a></h1> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># chkconfig:   - 85 15</span>

<span class="token comment"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</span>

<span class="token comment">#               proxy and IMAP/POP3 proxy server</span>

<span class="token comment"># processname: nginx</span>

<span class="token comment"># config:      /opt/nginx/conf/nginx.conf</span>

<span class="token comment"># pidfile:     /opt/nginx/logs/nginx.pid</span>

<span class="token comment"># Url http://www.xnuo.top</span>

<span class="token comment"># Last Updated 2020.12.22</span>

<span class="token comment"># Source function library.</span>

<span class="token builtin class-name">.</span> /etc/rc.d/init.d/functions

<span class="token comment"># Source networking configuration.</span>

<span class="token builtin class-name">.</span> /etc/sysconfig/network

<span class="token comment"># Check that networking is up.</span>
<span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$NETWORKING</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;no&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>

<span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token string">&quot;/opt/nginx/sbin/nginx&quot;</span>
<span class="token assign-left variable">prog</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $nginx<span class="token variable">)</span></span>

<span class="token assign-left variable">NGINX_CONF_FILE</span><span class="token operator">=</span><span class="token string">&quot;/opt/nginx/conf/nginx.conf&quot;</span>
<span class="token assign-left variable">NGINX_PID</span><span class="token operator">=</span><span class="token string">&quot;/opt/nginx/logs/nginx.pid&quot;</span>

<span class="token punctuation">[</span> -f /etc/sysconfig/nginx <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">.</span> /etc/sysconfig/nginx

<span class="token assign-left variable">lockfile</span><span class="token operator">=</span>/var/lock/subsys/nginx

<span class="token function-name function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span> -x <span class="token variable">$nginx</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">5</span>
    <span class="token punctuation">[</span> -f <span class="token variable">$NGINX_CONF_FILE</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">6</span>
    <span class="token builtin class-name">echo</span> -n $<span class="token string">&quot;Starting <span class="token variable">$prog</span>: &quot;</span>
    daemon <span class="token variable">$nginx</span> -c <span class="token variable">$NGINX_CONF_FILE</span>
    <span class="token assign-left variable">retval</span><span class="token operator">=</span><span class="token variable">$?</span>
    <span class="token builtin class-name">echo</span>
    <span class="token comment">#service php-fpm start</span>
    <span class="token punctuation">[</span> <span class="token variable">$retval</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> <span class="token variable">$lockfile</span>
    <span class="token builtin class-name">return</span> <span class="token variable">$retval</span>
<span class="token punctuation">}</span>
<span class="token function-name function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> -n $<span class="token string">&quot;Stopping <span class="token variable">$prog</span>: &quot;</span>
    <span class="token variable">$nginx</span> -s stop
    echo_success
    <span class="token assign-left variable">retval</span><span class="token operator">=</span><span class="token variable">$?</span>
    <span class="token builtin class-name">echo</span>
    <span class="token comment">#service php-fpm stop</span>
    <span class="token punctuation">[</span> <span class="token variable">$retval</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -f <span class="token variable">$lockfile</span>
    <span class="token builtin class-name">return</span> <span class="token variable">$retval</span>
<span class="token punctuation">}</span>

<span class="token function-name function">restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stop
    start
<span class="token punctuation">}</span>

<span class="token function-name function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    configtest <span class="token operator">||</span> <span class="token builtin class-name">return</span> <span class="token variable">$?</span>
    <span class="token builtin class-name">echo</span> -n $<span class="token string">&quot;Reloading <span class="token variable">$prog</span>: &quot;</span>
    <span class="token variable">$nginx</span> -s reload
    <span class="token assign-left variable">RETVAL</span><span class="token operator">=</span><span class="token variable">$?</span>
    <span class="token builtin class-name">echo</span>
<span class="token punctuation">}</span>

<span class="token function-name function">force_reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    restart
<span class="token punctuation">}</span>

<span class="token function-name function">configtest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$nginx</span> -t -c <span class="token variable">$NGINX_CONF_FILE</span>
<span class="token punctuation">}</span>

<span class="token function-name function">rh_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status <span class="token variable">$prog</span>
<span class="token punctuation">}</span>

<span class="token function-name function">rh_status_q</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rh_status <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
<span class="token punctuation">}</span>

<span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token keyword">in</span>
    start<span class="token punctuation">)</span>
        rh_status_q <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>
        <span class="token variable">$1</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    stop<span class="token punctuation">)</span>
        rh_status_q <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>
        <span class="token variable">$1</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    restart<span class="token operator">|</span>configtest<span class="token punctuation">)</span>
        <span class="token variable">$1</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    reload<span class="token punctuation">)</span>
        rh_status_q <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">7</span>
        <span class="token variable">$1</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    force-reload<span class="token punctuation">)</span>
        force_reload
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    status<span class="token punctuation">)</span>
        rh_status
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    condrestart<span class="token operator">|</span>try-restart<span class="token punctuation">)</span>
        rh_status_q <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
        <span class="token builtin class-name">echo</span> $<span class="token string">&quot;Usage: <span class="token variable">$0</span> {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}&quot;</span>
        <span class="token builtin class-name">exit</span> <span class="token number">2</span>
<span class="token keyword">esac</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><h5 id="_6-2-centos7启动脚本"><a href="#_6-2-centos7启动脚本" class="header-anchor">#</a> 6.2 centos7启动脚本</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /lib/systemd/system/nginx.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>nginx
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/opt/nginx/sbin/nginx
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/opt/nginx/sbin/nginx reload
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/opt/nginx/sbin/nginx quit
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="设置nginx为http文件服务器"><a href="#设置nginx为http文件服务器" class="header-anchor">#</a> 设置nginx为http文件服务器</h4> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
 <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
 <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>
 <span class="token directive"><span class="token keyword">root</span> /yumrepo</span><span class="token punctuation">;</span>
 <span class="token directive"><span class="token keyword">charset</span> utf-8,gbk</span><span class="token punctuation">;</span>
 <span class="token comment">#access_log  logs/host.access.log  main;</span>
 <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
​     <span class="token directive"><span class="token keyword">autoindex</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
​     <span class="token directive"><span class="token keyword">autoindex_exact_size</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
​     <span class="token directive"><span class="token keyword">autoindex_localtime</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="配置fastcgi"><a href="#配置fastcgi" class="header-anchor">#</a> 配置fastcgi</h4> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">fastcgi_connect_timeout</span> <span class="token number">300</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">fastcgi_send_timeout</span> <span class="token number">300</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">fastcgi_read_timeout</span> <span class="token number">300</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">fastcgi_buffer_size</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">fastcgi_buffers</span> <span class="token number">4</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">fastcgi_busy_buffers_size</span> <span class="token number">128k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">fastcgi_temp_file_write_size</span> <span class="token number">128k</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">fastcgi_pass</span>  localhost:9000</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">fastcgi_param</span> SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">fastcgi_param</span> QUERY_STRING    <span class="token variable">$query_string</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> ~ \.(gif|jpg|png)$</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /data/images</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="nginx-upstream配置"><a href="#nginx-upstream配置" class="header-anchor">#</a> nginx upstream配置</h4> <p>在开发过程中，开发完成，完成测试阶段，修复bug后都要重启后台服务，测试又在测试，每次重启都要一两分钟，平凡的重启，测试不干了；所以想到就是部署两台服务器；用nginx upstream 模块实现 无感知部署，发现一个bug，修复；直接部署不会打断测试；</p> <p>原来的测试环境部署的jenkins部署的，在一台机器中部署了，现在要需要增加一个部署一台机器；我们在jenkins的项目中部署脚本中再部署一个项目；
部署思想：打时间差，就是先后部署这两台机器，控制好时间，保证有一台机器可以使用；我在jenkins在部署的时候，用了一个sleep 100  来启动间隔，间隔是100秒，100秒后台，重新</p> <p>启动第二台服务器；
服务器1  ： 192.168.1.120:7851
服务器2  :  192.168.1.121:7851
废话不多说，直接上配置文件  test.conf （配置文件直接上）</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> adminProxy</span><span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">server</span> 192.168.1.120:7851 weight=2 max_fails=3 fail_timeout=100s</span><span class="token punctuation">;</span>
      <span class="token directive"><span class="token keyword">server</span> 192.168.1.121:7851 weight=2  max_fails=3 fail_timeout=100s</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> dev.manage.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span> /home/work/app/dist</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">index</span> index.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /sys</span>  <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://adminProxy</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">proxy_next_upstream</span> http_502 http_504 error timeout invalid_header</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>max_fails = 3 fail_timeout=100s  表示 ${fail_timeout}（100秒）时间内出现${max-fails}（3次）次失败，就会把这个机器状态置为down（下线），就是失败$(fail_timeout)(100秒)时间后，会重新尝试启用这服务器；
这样就配置好一个两台服务器负载均衡的配置了；</p> <p>但是这还是不够的；因为这样的话，一个服务器要被请求3次才会被下线，也就是说，会有3次错误的请求；返回502或者是error；
所以我们还要启用proxy_next_upstream 功能： 在服务器返回502,504，错误，超时 的时候；允许转发到其他服务器；
proxy_next_upstream http_502 http_504 error timeout invalid_header;
启用该功能需要在nginx.conf中添加
proxy_next_upstream on</p> <p>注：就是在部署这两台服务器的时候，最好能够和这边nginx配置的服务器失败重试时间一致；这样nginx失败转发就不会出错，用户也会无感知；</p> <p>附上怎么在jenkins中部署代码到另外一台机器上：</p> <p>步骤： 1、两台服务器添加信任（ssh的互相信赖，这样在远程copy文件执行脚本的时候就不用密码连接，不知道的可以百度）
2、把jenkins编译好的文件远程copy到第二台服务器中
3、用jenkins远程调用启动脚本</p> <p>直接上脚本：
jenkins 部署脚本：
sleep 100</p> <p>scp  ./admin/target/admin.jar  root@192.168.1.121:/home/work/withhold-feature/admin7851.jar</p> <p>ssh root@192.168.1.121 &quot;/home/work/withhold-feature/start-jar.sh&quot;
注：这个脚本是在启动第一台服务器（192.168.1.120）的时候执行，先停顿100s 在第一台服务器（192.168.1.120）启动完成后，再重新启动第二台服务器（129.168.1.121）；
scp是把本地文件拷贝到远程服务器中，然后用 ssh 远程执行start-jar.sh  脚本</p> <p>在第二台服务器中的start-jar.sh 脚本</p> <p>pid=<code>ps -ef | grep admin7851.jar | grep -v grep | awk '{print $2}'</code>if [ -n &quot;$pid&quot; ]then#!kill -9 强制终止</p> <p>echo &quot;kill -9 的pid:&quot; $pid
kill -9 $pidfi
cd /home/work/withhold-feature</p> <p>nohup java -jar admin7851.jar --server.port=7851  --spring.profiles.active=test &gt;/dev/null &amp;</p> <h4 id="nginx虚拟路径映射"><a href="#nginx虚拟路径映射" class="header-anchor">#</a> nginx虚拟路径映射</h4> <p>实现效果
location /img/ {
root /home/user/image/;
}
如果按照如上配置，那在浏览器中访问一定是 http://127.0.0.1/img/img_file.jpg 。它的请求将会这样映射：/home/user/image/img/img_file.jpg，这样没有错，但是如果按照这样配置访问的话，在 /home/user/image/ 文件下一定需要再有一个 img 文件夹。但是现在我想要的效果为img_file.jpg文件直接存在于image文件夹下，且访问时也要加上img这样一个路径标识。
需要实现的效果大致效果为：
请求 ：http://127.0.0.1/img/img_file.jpg
映射为： /home/user/image/img_file.jpg
大致意思就是虽然配置了img这个路径标识，但是实际上我没有一个这样的文件夹。</p> <p>配置实现
其实很简单，只需要使用 alias 这个指令。配置如下：</p> <p>location /img/ {
alias /home/user/image/;
}
注：alias 后的路径最后需要加上 ‘/’ 不然会找不到文件。
这样就可以实现上述的需求。其实很好理解：
使用root的话它的实际映射为 root 后的路径 + location后的路径，也就是 /home/user/image/img/ ,
使用alias的话等于location 后的路径是alias 后路径的别名。</p> <h4 id="反向代理-虚拟二级目录"><a href="#反向代理-虚拟二级目录" class="header-anchor">#</a> 反向代理 虚拟二级目录</h4> <p>在nginx中配置proxy_pass代理转发时，如果在proxy_pass后面的url加/，表示绝对根路径；如果没有/，表示相对路径，把匹配的路径部分也给代理走。</p> <p>假设下面四种情况分别用 http://192.168.1.1/proxy/test.html 进行访问。</p> <p>第一种：
location /proxy/ {
proxy_pass http://127.0.0.1/;
}
代理到URL：http://127.0.0.1/test.html</p> <p>注意其中关键的两点，</p> <p>在location 后面的名称的末尾一定要加上/
在proxy_pass后面代理地址的末尾也需要加上/</p> <h4 id="nginx何防止流量攻击"><a href="#nginx何防止流量攻击" class="header-anchor">#</a> Nginx何防止流量攻击</h4> <p>两种实现方式分别是基于Ehcache和Redis的session管理策略。
大家都知道服务器资源有限的，但是客户端来的请求是无限的(不排除恶意攻击)， 为了保证大部分的请求能够正常响应，不得不放弃一些客户端来的请求，所以我们会采用Nginx的限流操作， 这种操作可以很大程度上缓解服务器的压力， 使其他正常的请求能够得到正常响应。
如何使用Nginx实现基本的限流，比如单个IP限制每秒访问100次。通过Nginx限流模块，我们可以设置一旦并发连接数超过我们的设置，将返回503错误给客户端。这样可以非常有效的防止CC攻击。再配合 iptables防火墙，基本上CC攻击就可以无视了。</p> <p>如何使用
conf配置
#统一在http域中进行配置
#限制请求
limit_req_zone $binary_remote_addr $uri zone=api_read:20m rate=100r/s;
#按ip配置一个连接 zone
limit_conn_zone $binary_remote_addr zone=perip_conn:10m;
#按server配置一个连接 zone
limit_conn_zone $server_name zone=perserver_conn:100m;</p> <p>server {
listen 80;
server_name test.domain.com;
index login.do;
location / {
#请求限流排队通过 burst默认是0
limit_req zone=api_read burst=5;
#连接数限制,每个IP并发请求为2
limit_conn perip_conn 2;
#服务所限制的连接数(即限制了该server并发连接数量)
limit_conn perserver_conn 1000;
#连接限速
limit_rate 100k;
proxy_pass http://test;
}
}
upstream report {
fair;
server 172.16.0.10:8882 weight=1 max_fails=2 fail_timeout=30s;
server 172.16.0.10:8881 weight=1 max_fails=2 fail_timeout=30s;
}</p> <p>配置说明
limit_conn_zone
是针对每个IP定义一个存储session状态的容器。这个示例中定义了一个100m的容器，按照32bytes/session，可以处理3200000个session。
limit_rate 300k;
对每个连接限速300k. 注意，这里是对连接限速，而不是对IP限速。如果一个IP允许两个并发连接，那么这个IP就是限速limit_rate×2。
burst=5；
这相当于在检查站req旁边放5个座位。如果某个请求当时超过速度限制被拦了，请他在空座位上坐着，等排队，如果检查站空了，就可以通过。如果连座位都坐满了，那就抱歉了，请求直接退回，客户端得到一个服务器忙的响应。所以说burst跟request_rate一点关系都没有，设成10000，就是1万个请求可以等着排队，而检查站还是1秒钟放行5个请求（龟速）。而且也不能一直排队，所以nginx还设了超时，排队超过一定时间，也是直接退回，返回服务器忙的响应。
以上配置Nginx需要配置以下模块：
ngx_http_limit_conn_module (static)
ngx_http_limit_req_module (static)
执行命令 nginx -V 就可以检查到是否有安装。</p> <h4 id="配置503错误"><a href="#配置503错误" class="header-anchor">#</a> 配置503错误</h4> <p>默认情况，超出限制额度，将会报503错误，提示：
503 Service Temporarily Unavailable
The server is temporarily unable to service your request due to maintenance downtime or capacity problems. Please try again later. Sorry for the inconvenience.
Please report this message and include the following information to us.
Thank you very much!</p> <p>这样显示没毛病，但是不够友好，这里我们自定义503错误。
error_page 500 502 503 504 /50x.html;
location = /50x.html {
root html;#自定义50X错误
}</p> <h4 id="nginx优化项"><a href="#nginx优化项" class="header-anchor">#</a> nginx优化项</h4> <p>·     <strong>隐藏nginx版本</strong></p> <p>·     <strong>nginx</strong> <strong>配置项优化</strong></p> <p>·     <strong>开启高效传输模式</strong></p> <p>·     <strong>fastcgi</strong> <strong>调优</strong></p> <p>·     <strong>gzip</strong> <strong>调优</strong></p> <p>·     <strong>expires</strong> <strong>缓存调优</strong></p> <p>·     <strong>内核参数优化</strong></p> <p>·     <strong>系统连接数的优化</strong></p> <p>准备nginx测试环境</p> <p>nginx安装略</p> <p>准备测试文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  vim /usr/local/nginx/conf/nginx.conf
  echo 'Hello world ' &gt; /usr/local/nginx/html/index.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>启动nginx服务</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>systemctl start nginx[root@localhost ~]# curl -I http://172.16.46.114
HTTP/1.1 200 OK
Server: nginx/1.12.2   #这里显示版本号
Date: Sat, 04 Jul 2020 05:20:43 GMT
Content-Type: text/html
Content-Length: 13
Last-Modified: Sat, 04 Jul 2020 03:57:39 GMT
Connection: keep-alive
ETag: &quot;5efffe33-d&quot;
Accept-Ranges: bytes
[root@localhost ~]# [root@localhost ~]# [root@localhost ~]# curl  http://172.16.46.114
Hello world 
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="隐藏nginx版本的2种方法"><a href="#隐藏nginx版本的2种方法" class="header-anchor">#</a> 隐藏nginx版本的2种方法</h5> <p><strong>通过修改nginx配置文件的方法</strong></p> <p>在HTTP字段添加下
<img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b525514da8b.gif" alt="IMG_256"></p> <p>再次查看请求头</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@localhost ~]# systemctl restart nginx
[root@localhost ~]# curl -I http://172.16.46.114
HTTP/1.1 200 OK
Server: nginx
Date: Sat, 04 Jul 2020 05:22:34 GMT
Content-Type: text/html
Content-Length: 13
Last-Modified: Sat, 04 Jul 2020 03:57:39 GMT
Connection: keep-alive
ETag: &quot;5efffe33-d&quot;
Accept-Ranges: bytes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b525519b17e.gif" alt="IMG_257"></p> <p><strong>重新编译法</strong></p> <p>修改源码包文件<code>src/core/nginx.h</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@localhost src<span class="token punctuation">]</span><span class="token comment"># cd nginx-1.12.2/</span>
<span class="token punctuation">[</span>root@localhost nginx-1.12.2<span class="token punctuation">]</span><span class="token comment"># vim src/core/nginx.h </span>
<span class="token punctuation">[</span>root@localhost nginx-1.12.2<span class="token punctuation">]</span><span class="token comment"># vi src/http/ngx_http_header_filter_module.c </span>
<span class="token comment">#彻底隐藏HTTP 头信息中的 connection 字段</span>
<span class="token punctuation">[</span>root@localhost nginx-1.12.2<span class="token punctuation">]</span><span class="token comment"># vi src/http/ngx_http_special_response.c </span>
<span class="token comment">#隐藏错误页面版本显示</span>
<span class="token punctuation">[</span>root@localhost nginx-1.12.2<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>src/core/nginx.h 修改如下：
<img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52552081e3.gif" alt="IMG_258"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@www nginx-1.12.2]# vi src/http/ngx_http_header_filter_module.c
修改前：
static char ngx_http_server_string[] = &quot;Server: nginx&quot; CRLF; //第 49 行
修改后：
static char ngx_http_server_string[] = &quot;Server: IIS&quot; CRLF;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>[root@www nginx-1.12.2]# vi src/http/ngx_http_special_response.c
修改前
static u_char ngx_http_error_tail[] = //第 29 行&quot;&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;&quot; CRLF&quot;&lt;/body&gt;&quot; CRLF&quot;&lt;/html&gt;&quot; CRLF;
修改后
static u_char ngx_http_error_tail[] =&quot;&lt;hr&gt;&lt;center&gt;IIS&lt;/center&gt;&quot; CRLF&quot;&lt;/body&gt;&quot; CRLF&quot;&lt;/html&gt;&quot; CRLF;
[root@localhost ~]# nginx -v
nginx version: IIS/8.8.8.8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="nginx配置项优化"><a href="#nginx配置项优化" class="header-anchor">#</a> nginx配置项优化</h5> <p><strong>nginx</strong>运行CPU亲和力</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>worker_processes 4;
worker_cpu_affinity 0001 0010 0100 1000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>8核如下</p> <p>worker_processes 8;</p> <p>worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000</p> <p>10000000;</p> <p>2核如下：
worker_processes 2;
worker_cpu_affinity 0101 1010；</p> <p><strong>nginx</strong>最多可以打开的文件数</p> <p>一个工作进程(<strong>worker process</strong>)建立一个连接后，进程将会打开一个文件副本，所以这个数(<strong>worker_connections</strong>)的大小还和操作系统设定的进程最大可打开的文件副本数有关。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>worker_rlimit_nofile 65535;
#这个指令是指当一个 nginx 进程打开的最多文件描述符数目，理论值应该是最多打开文件数
（ulimit -n）与 nginx 进程数相除，但是 nginx 分配请求并不是那么均匀，所以最好与 ulimit -n
的值保持一致
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>#文件资源限制的配置可以在/etc/security/limits.conf 设置，针对 root/user 等各个用户或者*
代表所有用户来设置。
*              soft    nofile 65535
*              hard    nofile 65535
*              soft    noproc 65535
*       hard    noproc 65535
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>nginx</strong>事件处理模型</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>events {
use epoll;
worker_connections 65535;
multi_accept on;}
#nginx 采用 epoll 事件模型，处理效率高#work_connections 是单个 worker 进程允许客户端最大连接数，这个数值一般根据服务器性
能和内存来制定，实际最大值就是 `worker 进程数乘以 work_connections`
实际我们填入一个 65535，足够了，这些都算并发值，一个网站的并发达到这么大的数量，
也算一个大站了！`multi_accept 告诉 nginx 收到一个新连接通知后接受尽可能多的连接`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>开启高效传输模式</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http {
include mime.types;
default_type application/octet-stream;
……
sendfile on;
tcp_nopush on;
……
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注释：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># Include mime.types; //媒体类型, include 只是一个在当前文件中包含另一个文件内容的指令# default_type application/octet-stream; //默认媒体类型足够# sendfile on； //开启高效文件传输模式，# tcp_nopush on； 必须在 sendfile 开启模式才有效，防止网路阻塞，积极的减少网络报文段的数量
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>连接超时时间</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>keepalive_timeout 60;
tcp_nodelay on;
client_header_buffer_size 4k;
open_file_cache max=102400 inactive=20s;
open_file_cache_valid 30s;
open_file_cache_min_uses 1;
client_header_timeout 15;
client_body_timeout 15;
reset_timedout_connection on;
send_timeout 15;
server_tokens off;
client_max_body_size 10m;
# keepalived_timeout; 客户端连接保持会话超时时间，超过这个时间，服务器断开这个链接# tcp_nodelay；也是防止网络阻塞，不过要包涵在 keepalived 参数才有效# client_header_buffer_size 4k; 客户端请求头部的缓冲区大小# open_file_cache max=102400 inactive=20s;这个将为打开文件指定缓存，默认是没有启用的# open_file_cache_valid 30s;这个是指多长时间检查一次缓存的有效信息。# open_file_cache_min_uses 1;# open_file_cache 指令中的 inactive 参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的# client_header_timeout 设置请求头的超时时间# client_body_timeout 设置请求体的超时时间# reset_timeout_connection 告诉 nginx 关闭不响应的客户端连接。# send_timeout 响应客户端超时时间# server_tokens 并不会让 nginx 执行的速度更快，但它可以关闭在错误页面中的 nginx 版本数字，这样对于安全性是有好处的。# client_max_body_size; 上传文件大小限制
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>fastcgi</strong>与proxy <strong>缓存调优</strong></p> <p>nginx 的 web 缓存功能的主要是由 <strong>proxy_cache</strong>、<strong>fastcgi_cache</strong> 指令集和关指令收集完成。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>proxy_cache ``指令负责反向代理缓存后端服务器的静态内容
fastcgi_cache ``主要用来处理FastCGI 动态进程缓存
 client_max_body_size 10m;
 client_body_buffer_size 128k;
 proxy_connect_timeout 75;
 proxy_send_timeout 75;
 proxy_read_timeout 75;
 proxy_buffer_size 4k;
 proxy_buffers 4 32k;
 proxy_busy_buffers_size 64k;
 proxy_temp_file_write_size 64k;
 proxy_buffering on;
 proxy_temp_path /usr/local/nginx/proxy_temp;
 proxy_cache_path /usr/local/nginx/proxy_cache levels=1:2 keys_zone=my-cache:100m 
 max_size=1000m inactive=600m max_size=2g;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>nginx做反向代理转发优化</p> <p>代理参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
proxy_connect_timeout 30;
proxy_send_timeout 60;
proxy_read_timeout 60;
 
proxy_buffering on;
proxy_buffer_size 32k;
proxy_buffers 4 128k;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果nginx后面接的是动态的网站，需要fastcgi接口转发请求到（PHP）</p> <p>缓存调优如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>fastcgi_connect_timeout 600;
fastcgi_send_timeout 600;
fastcgi_read_timeout 600;
fastcgi_buffer_size 64k;
fastcgi_buffers 4 64k;
fastcgi_busy_buffers_size 128k;
fastcgi_temp_file_write_size 128k;
fastcgi_temp_path /usr/local/nginx/nginx_tmp;
fastcgi_intercept_errors on;
fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m 
inactive=1d max_size=10g;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>转发调优如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location ~ \.php$ {
                root /wordpress; 
                fastcgi_pass 127.0.0.1:9000;
                fastcgi_index index.php; 
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;  
                fastcgi_cache cache_fastcgi;
                           fastcgi_cache_valid 200 302 1h;
                               fastcgi_cache_valid 301 1d;
                               fastcgi_cache_valid any 1m;
                               fastcgi_cache_min_uses 1;
                               fastcgi_cache_key http://$host$request_uri;
                include fastcgi_params; #引用fastcgi_params目录
        }
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>注释：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>fastcgi_connect_timeout 600; #指定连接到后端 FastCGI 的超时时间。
fastcgi_send_timeout 600; #向 FastCGI 传送请求的超时时间。
fastcgi_read_timeout 600; #指定接收 FastCGI 应答的超时时间。
fastcgi_buffer_size 64k; #指定读取 FastCGI 应答第一部分需要用多大的缓冲区，默认的缓冲区大小为 fastcgi_buffers 指令中的每块大小，可以将这个值设置更小。
fastcgi_buffers 4 64k; #指定本地需要用多少和多大的缓冲区来缓冲 FastCGI 的应答请求
fastcgi_busy_buffers_size 128k; #建议设置为 fastcgi_buffers 的两倍，繁忙时候的 buffer
fastcgi_temp_file_write_size 128k; #在写入 fastcgi_temp_path 时将用多大的数据块，默认值是 fastcgi_buffers 的两倍
fastcgi_temp_path #缓存临时目录
fastcgi_intercept_errors on;# 这个指令指定是否传递 4xx 和 5xx 错误信息到客户端，或者允许nginx 使用 error_page 处理错误信息
fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m 
inactive=1d max_size=10g; # fastcgi_cache 缓存目录
fastcgi_cache cache_fastcgi; #表示开启 FastCGI 缓存并为其指定一个名称.inactive 表示默认
失效时间，如果缓存数据在失效时间内没有被访问,将被删除，max_size 表示最多用多少硬盘空间
fastcgi_pass #指定 FastCGI 服务器监听端口与地址
fastcgi_cache_valid 200 302 1h; #用来指定应答代码的缓存时间，实例中的值表示将 200 和302 应答缓存一小时，要和 fastcgi_cache 配合使用
fastcgi_cache_valid 301 1d; #将 301 应答缓存一天
fastcgi_cache_valid any 1m; #将其他应答缓存为 1 分钟
fastcgi_cache_min_uses 3; #该指令用于设置经过多少次请求的相同 URL 将被缓存
fastcgi_cache_key http://$host$request_uri; #该指令用来设置web缓存的Key值,nginx根据Key
值 md5 哈希存 储 .一 般根 据$host( 域名 )、$request_uri(请 求的路 径 ) 等变 量组 合成
proxy_cache_key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>gzip</strong> <strong>调优</strong></p> <p>使用 gzip 压缩功能，可能为我们节约带宽，加快传输速度，有更好的体验</p> <p>同时也要注意，我们使用 gzip 的功能是需要消耗 <strong>CPU</strong> 的！</p> <p>Nginx 启用压缩功能需要你来 <strong>ngx_http_gzip_module</strong> 模块,一般我们需要压缩的内容有：文本，js，html，css，对于图片，视频，flash 什么的不压缩;</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>gzip on;
gzip_min_length 2k;
gzip_buffers 4 32k;
gzip_http_version 1.1;
gzip_comp_level 6;
gzip_types text/plain text/css text/javascript application/json application/javascript 
application/x-javascript application/xml;
gzip_vary on;
gzip_proxied any;
gzip on; #开启压缩功能
gzip_min_length 1k; #设置允许压缩的页面最小字节数
gzip_buffers 4 32k; #压缩缓冲区大小
gzip_http_version 1.1; #压缩版本
gzip_comp_level 6; #压缩比例,1 压缩比最小，处理速度最快，9 压缩比最大，传输速度快，但是处理慢，也比较消耗 CPU 资源;6比较中性
gzip_types text/css text/xml application/javascript; #用来指定压缩的类型
gzip_vary on; #vary header 支持
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>expires</strong> <strong>缓存调优</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>缓存，主要针对于图片，css，js 等元素更改机会比较少的情况下使用，特别是图片，占用
带宽大，我们完全可以设置图片在浏览器本地缓存 30d，css，js，html 可以缓存个 10 来天，
这样用户第一次打开加载慢一点，第二次，就非常快了！缓存的时候，我们需要将需要缓存
的拓展名列出来， Expires 缓存配置在 server 字段里面
location ~* \.(ico|jpeg|gif|png|bmp|swf|flv)$ {
 expires 30d;
 log_not_found off;
 access_log off;}
location ~* \.(js|css)$ {
 expires 7d;
 log_not_found off;
 access_log off;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>log_not_found off;是否在 error_log 中记录不存在的错误，默认是</p> <h5 id="nginx整体配置优化"><a href="#nginx整体配置优化" class="header-anchor">#</a> nginx整体配置优化</h5> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52552399ab.gif" alt="IMG_259"></p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b5255275f6d.gif" alt="IMG_260"></p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52552b67c6.gif" alt="IMG_261"> <img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b52552f07c9.gif" alt="IMG_262"> <strong>关于系统连接数的优化</strong></p> <p>linux 默认值 open files 为 1024</p> <p>修改open files 最大连接数</p> <p>如下图：</p> <p><img src="https://cdn.jsdelivr.net/gh/opersdev/image/i/2022/06/24/62b525532ba6a.gif" alt="IMG_263"></p> <p>编辑/etc/security/limits.conf</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>*       soft    nifile 65535
*       hard    nifile 65535
*       soft    noproc 65535
*       hard    noproc 65535
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ulimit -n 65535 / reboot 保证本次会话生效</p> <p>验证生效</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@localhost ~]# ps -aux | grep nginx
root       1006  0.0  0.0 177032  1288 ?        Ss   08:31   0:00 nginx: master process /usr/local/nginx/sbin/nginx
nginx      1009  0.3  1.5 206252 28804 ?        S    08:31   0:00 nginx: worker process
nginx      1010  0.2  1.5 206252 28804 ?        S    08:31   0:00 nginx: worker process
nginx      1011  0.0  0.0 179272  1776 ?        S    08:31   0:00 nginx: cache manager process
root       3365  0.0  0.0 112656   960 pts/0    S+   08:33   0:00 grep --color=auto nginx[root@localhost ~]# cat /proc/1009/limits 
Limit                     Soft Limit           Hard Limit           Units     
Max cpu time              unlimited            unlimited            seconds   
Max file size             unlimited            unlimited            bytes     
Max data size             unlimited            unlimited            bytes     
Max stack size            8388608              unlimited            bytes     
Max core file size        0                    unlimited            bytes     
Max resident set          unlimited            unlimited            bytes     
Max processes             7179                 7179                 processes 
Max open files            65535                65535                files     
Max locked memory         65536                65536                bytes     
Max address space         unlimited            unlimited            bytes     
Max file locks            unlimited            unlimited            locks     
Max pending signals       7179                 7179                 signals   
Max msgqueue size         819200               819200               bytes     
Max nice priority         0                    0                    
Max realtime priority     0                    0                    
Max realtime timeout      unlimited            unlimited            us        
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>可见，openfile已经更改</p> <h4 id="负载均衡和反向代理"><a href="#负载均衡和反向代理" class="header-anchor">#</a> 负载均衡和反向代理</h4> <p>支持多种协议的反向代理</p> <h5 id="upstream"><a href="#upstream" class="header-anchor">#</a> upstream</h5> <p>四层反向代理</p> <p>tcp,udp</p> <p>七层反向代理</p> <p>memcached,scgi,fastcgi,uwsgi,grpc,http,websocket</p> <p>upstream name {...}</p> <p>context: http</p> <p>syntax: server address</p> <p>地址可以是域名、IP地址、unix socket地址</p> <p>通用参数</p> <p>backup  备份server</p> <p>down 标识服务器下线</p> <p>加权Round-Robin负载均衡算法</p> <p>weight 权重</p> <p>max_conns</p> <p>server的最大并发连接数，仅作用于单worker进程</p> <p>max_fails</p> <p>在fail_timeout时间段内，最大的失败次数。当达到最大失败时，会在fail_timeout秒内这台server不允许再次被选择</p> <p>fail_timeout</p> <p>单位为秒，默认值10秒。具有2个功能：</p> <p>指定一段时间内，最大的失败次数max_fails.</p> <p>到达max_fails后，该server不能访问的时间。</p> <h5 id="对上游服务使用keepalive长连接"><a href="#对上游服务使用keepalive长连接" class="header-anchor">#</a> 对上游服务使用keepalive长连接</h5> <p>通过复用连接，降低nginx与上游服务器建立、关闭连接的消耗，提升吞吐量的同时降低时延</p> <p>模块 ngx_http_upstream_keepalive_module,默认编译进nginx,通过--without-http_upstream_keepalive_module移除</p> <p>对上游连接的http头部设定</p> <p>proxy_http_version 1.1;</p> <p>proxy_set_header Connection;</p> <p>upstream_keepalive的指令</p> <p>keepalive connections;</p> <p>context: upstrem</p> <p>keepalive_requests number;</p> <p>keepalived_timeout timeout;</p> <p>指定上游服务域名解析的resolver指令</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">listen</span> <span class="token number">8011</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">default_type</span> text/plain</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">'8011 server response.<span class="token escape entity">\n</span>'</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">listen</span> <span class="token number">8012</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">default_type</span> text/plain</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">'8012 server response.<span class="token escape entity">\n</span>'</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> rrups</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8011 weight=2 max_conns=2 max_fails=2 fail_timeout=5</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8012</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">32</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">server_name</span> web.ops.com</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">error_log</span> /var/log/nginx/myerror.log info</span><span class="token punctuation">;</span>
	
	<span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
		<span class="token directive"><span class="token keyword">proxy_pass</span> http://rrups</span><span class="token punctuation">;</span>
		<span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
		<span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;&quot;</span></span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>tcpdump -i lo port 8011</p> <p>基于客户端IP地址的hash算法实现负载均衡：upstream_ip_hash模块</p> <p>ip_hash;</p> <p>context: upstream</p> <p>以客户端的IP地址作为hash算法的关键字，映射到特定的上游服务器中。</p> <p>可以基于realip模块修改用于执行算法的IP地址</p> <p>基于任意关键字实现hash算法的负载均衡：</p> <p>upstream_hash模块</p> <p>通过指定关键字作为hash key,基于Hash算法映射到特定的上游服务器中</p> <p>​	关键字可以含有变量、字符串</p> <p>hash key [consistent];</p> <p>context: upstream</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> iphashups</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">ip_hash</span></span><span class="token punctuation">;</span>
	<span class="token comment">#hash user_$arg_username;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8011 weight=2 max_conns=2 max_fails=2 fail_timeout=5</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8012 weight=1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">set_real_ip_from</span> 192.168.200.225</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">real_ip_recursive</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">real_ip_header</span> X-Forwarded-For</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">server_name</span> iphash.opstand.com</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">error_log</span> /var/log/nginx/myerror.log info</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/upstream_access.log</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">location</span> /</span><span class="token punctuation">{</span>
<span class="token directive"><span class="token keyword">proxy_pass</span> http://iphashups</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;&quot;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>curl -H 'X-Forwarded-For: 100.200.20.200' iphash.opstand.com</p> <p>curl -H 'X-Forwarded-For: 100.200.20.200' iphash.opstand.com?username=bbbbbfssf</p> <p>宕机或者扩容时，hash算法引发大量路由变更，可能导致缓存大范围失效</p> <p>一致性hash算法：扩容前</p> <p>使用一致性hash算法：upstream_hash模块</p> <p>hash key [consitent];</p> <p>context: upstream</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/f34d31/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">rabbitmq</div></a> <a href="/pages/2b9364/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">nginx</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/f34d31/" class="prev">rabbitmq</a></span> <span class="next"><a href="/pages/2b9364/">nginx</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/613b69/"><div>
            postgresql安装
            <!----></div></a> <span class="date">06-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/8ae632/"><div>
            oracle笔记
            <!----></div></a> <span class="date">06-24</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/765fc1/"><div>
            opengauss笔记
            <!----></div></a> <span class="date">06-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:48211701@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/opersdev" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://all.xnuo.top" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>kevin | <a href="https://github.com/opersdev" target="_blank">小诺运维</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.38f1b0a4.js" defer></script><script src="/assets/js/2.6beb1dc7.js" defer></script><script src="/assets/js/17.1da2b6ae.js" defer></script>
  </body>
</html>
